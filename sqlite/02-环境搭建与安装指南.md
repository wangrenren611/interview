# 环境搭建与安装指南

## 目录
1. [系统环境要求](#系统环境要求)
2. [Node.js环境安装](#nodejs环境安装)
3. [SQLite安装与配置](#sqlite安装与配置)
4. [Node.js SQLite库安装](#nodejs-sqlite库安装)
5. [开发工具配置](#开发工具配置)
6. [项目初始化](#项目初始化)
7. [常见安装问题解决](#常见安装问题解决)
8. [环境验证](#环境验证)

---

## 系统环境要求

### 支持的操作系统

SQLite和Node.js都支持跨平台运行，以下是各系统的支持情况：

| 操作系统 | Node.js支持 | SQLite支持 | 推荐版本 |
|----------|-------------|------------|----------|
| Windows | ✅ | ✅ | Windows 10/11 |
| macOS | ✅ | ✅ | macOS 10.15+ |
| Linux | ✅ | ✅ | Ubuntu 18.04+ |
| FreeBSD | ✅ | ✅ | FreeBSD 12+ |

### 硬件要求

**最低配置**：
- CPU：1核心
- 内存：512MB RAM
- 磁盘：100MB可用空间

**推荐配置**：
- CPU：2核心以上
- 内存：2GB RAM以上
- 磁盘：1GB可用空间

### 软件依赖

**必需软件**：
- Node.js (v14.0.0+)
- npm (v6.0.0+) 或 yarn (v1.22.0+)
- Git (用于版本控制)

**可选软件**：
- Visual Studio Code (推荐编辑器)
- SQLite Browser (数据库管理工具)
- Postman (API测试工具)

---

## Node.js环境安装

### 方法一：官方安装包（推荐）

**Windows系统**：
1. 访问 [Node.js官网](https://nodejs.org/)
2. 下载LTS版本（长期支持版本）
3. 运行安装程序，按默认选项安装
4. 验证安装：

```bash
node --version
npm --version
```

**macOS系统**：
1. 访问 [Node.js官网](https://nodejs.org/)
2. 下载macOS安装包
3. 双击.pkg文件安装
4. 验证安装：

```bash
node --version
npm --version
```

**Linux系统**：
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS/RHEL
curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo bash -
sudo yum install -y nodejs

# 验证安装
node --version
npm --version
```

### 方法二：使用包管理器

**macOS (Homebrew)**：
```bash
# 安装Homebrew（如果未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装Node.js
brew install node

# 验证安装
node --version
npm --version
```

**Windows (Chocolatey)**：
```powershell
# 安装Chocolatey（如果未安装）
Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

# 安装Node.js
choco install nodejs

# 验证安装
node --version
npm --version
```

### 方法三：使用Node版本管理器

**nvm (Node Version Manager)**：
```bash
# 安装nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 重新加载终端配置
source ~/.bashrc

# 安装最新LTS版本
nvm install --lts
nvm use --lts

# 验证安装
node --version
npm --version
```

**Windows (nvm-windows)**：
```powershell
# 下载并安装nvm-windows
# 从 https://github.com/coreybutler/nvm-windows/releases 下载

# 安装最新LTS版本
nvm install lts
nvm use lts

# 验证安装
node --version
npm --version
```

---

## SQLite安装与配置

### 方法一：系统包管理器安装

**Windows**：
```bash
# 使用Chocolatey
choco install sqlite

# 或使用Scoop
scoop install sqlite
```

**macOS**：
```bash
# 使用Homebrew
brew install sqlite

# 验证安装
sqlite3 --version
```

**Linux (Ubuntu/Debian)**：
```bash
sudo apt update
sudo apt install sqlite3

# 验证安装
sqlite3 --version
```

**Linux (CentOS/RHEL)**：
```bash
sudo yum install sqlite

# 或使用dnf (较新版本)
sudo dnf install sqlite

# 验证安装
sqlite3 --version
```

### 方法二：预编译二进制文件

**下载预编译版本**：
1. 访问 [SQLite官网下载页面](https://www.sqlite.org/download.html)
2. 下载适合您系统的预编译二进制文件
3. 解压到合适目录
4. 添加到系统PATH环境变量

**Windows示例**：
```batch
# 下载sqlite-tools-win32-x86-*.zip
# 解压到 C:\sqlite\
# 添加到PATH环境变量
set PATH=%PATH%;C:\sqlite\
```

**Linux/macOS示例**：
```bash
# 下载sqlite-tools-linux-x86-*.zip
wget https://www.sqlite.org/2024/sqlite-tools-linux-x86-3460000.zip
unzip sqlite-tools-linux-x86-3460000.zip
sudo mv sqlite-tools-linux-x86-3460000 /opt/sqlite
echo 'export PATH=$PATH:/opt/sqlite' >> ~/.bashrc
source ~/.bashrc
```

### 方法三：从源码编译

**Linux/macOS**：
```bash
# 下载源码
wget https://www.sqlite.org/2024/sqlite-autoconf-3460000.tar.gz
tar -xzf sqlite-autoconf-3460000.tar.gz
cd sqlite-autoconf-3460000

# 编译安装
./configure --prefix=/usr/local
make
sudo make install

# 验证安装
sqlite3 --version
```

---

## Node.js SQLite库安装

### 1. sqlite3库安装

**基本安装**：
```bash
npm install sqlite3
```

**全局安装（可选）**：
```bash
npm install -g sqlite3
```

**指定版本安装**：
```bash
npm install sqlite3@5.1.6
```

### 2. better-sqlite3库安装

**基本安装**：
```bash
npm install better-sqlite3
```

**指定版本安装**：
```bash
npm install better-sqlite3@8.7.0
```

### 3. 从源码编译安装

**sqlite3从源码编译**：
```bash
# 安装编译工具
# Windows: 安装Visual Studio Build Tools
# macOS: 安装Xcode Command Line Tools
# Linux: 安装build-essential

npm install sqlite3 --build-from-source
```

**better-sqlite3从源码编译**：
```bash
npm install better-sqlite3 --build-from-source
```

### 4. 使用外部SQLite库

**指定SQLite路径**：
```bash
# 使用系统安装的SQLite
npm install sqlite3 --build-from-source --sqlite=/usr/local

# 使用Homebrew安装的SQLite (macOS)
npm install sqlite3 --build-from-source --sqlite=/opt/homebrew
```

### 5. 安装问题解决

**Windows编译问题**：
```bash
# 安装Windows Build Tools
npm install --global windows-build-tools

# 或使用Visual Studio Installer安装C++构建工具
```

**macOS编译问题**：
```bash
# 安装Xcode Command Line Tools
xcode-select --install

# 设置编译器路径
export CC=clang
export CXX=clang++
```

**Linux编译问题**：
```bash
# Ubuntu/Debian
sudo apt install build-essential python3-dev

# CentOS/RHEL
sudo yum groupinstall "Development Tools"
sudo yum install python3-devel
```

---

## 开发工具配置

### 1. Visual Studio Code配置

**推荐扩展**：
```json
{
  "recommendations": [
    "ms-vscode.vscode-typescript-next",
    "bradlc.vscode-tailwindcss",
    "ms-vscode.vscode-json",
    "formulahendry.auto-rename-tag",
    "esbenp.prettier-vscode",
    "ms-vscode.vscode-eslint",
    "alexcvzz.vscode-sqlite"
  ]
}
```

**工作区设置**：
```json
{
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "files.associations": {
    "*.sql": "sql"
  },
  "sqlite.databasePath": "./database.db"
}
```

### 2. SQLite Browser安装

**Windows**：
```bash
# 使用Chocolatey
choco install sqlitebrowser

# 或从官网下载
# https://sqlitebrowser.org/dl/
```

**macOS**：
```bash
# 使用Homebrew
brew install --cask db-browser-for-sqlite

# 或从App Store安装
```

**Linux**：
```bash
# Ubuntu/Debian
sudo apt install sqlitebrowser

# CentOS/RHEL
sudo yum install sqlitebrowser
```

### 3. 数据库管理工具

**DBeaver（推荐）**：
```bash
# 下载并安装DBeaver Community Edition
# https://dbeaver.io/download/

# 配置SQLite连接
# 1. 新建连接
# 2. 选择SQLite
# 3. 指定数据库文件路径
```

**TablePlus**：
```bash
# macOS
brew install --cask tableplus

# Windows
# 从官网下载安装包
```

---

## 项目初始化

### 1. 创建项目目录

```bash
# 创建项目目录
mkdir my-sqlite-app
cd my-sqlite-app

# 初始化npm项目
npm init -y
```

### 2. 安装依赖

```bash
# 安装SQLite库
npm install sqlite3

# 安装其他常用依赖
npm install express cors dotenv

# 安装开发依赖
npm install --save-dev nodemon eslint prettier
```

### 3. 项目结构

```
my-sqlite-app/
├── src/
│   ├── database/
│   │   ├── connection.js
│   │   ├── migrations/
│   │   └── seeds/
│   ├── models/
│   ├── routes/
│   ├── middleware/
│   └── utils/
├── public/
├── tests/
├── docs/
├── package.json
├── .env
├── .gitignore
└── README.md
```

### 4. 配置文件

**package.json**：
```json
{
  "name": "my-sqlite-app",
  "version": "1.0.0",
  "description": "Node.js SQLite Application",
  "main": "src/app.js",
  "scripts": {
    "start": "node src/app.js",
    "dev": "nodemon src/app.js",
    "test": "jest",
    "lint": "eslint src/",
    "format": "prettier --write src/"
  },
  "dependencies": {
    "sqlite3": "^5.1.6",
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1"
  },
  "devDependencies": {
    "nodemon": "^3.0.1",
    "eslint": "^8.50.0",
    "prettier": "^3.0.3"
  }
}
```

**.env**：
```env
# 数据库配置
DB_PATH=./database/app.db
DB_MODE=WAL

# 服务器配置
PORT=3000
NODE_ENV=development

# 日志配置
LOG_LEVEL=info
```

**.gitignore**：
```gitignore
# 依赖
node_modules/
npm-debug.log*

# 环境变量
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# 数据库文件
*.db
*.db-journal
*.db-wal
*.db-shm

# 日志
logs/
*.log

# 运行时
pids/
*.pid
*.seed
*.pid.lock

# 覆盖率
coverage/
.nyc_output/

# IDE
.vscode/
.idea/
*.swp
*.swo

# 操作系统
.DS_Store
Thumbs.db
```

### 5. 基础代码结构

**src/database/connection.js**：
```javascript
const sqlite3 = require('sqlite3').verbose();
const path = require('path');
require('dotenv').config();

class DatabaseConnection {
    constructor() {
        this.db = null;
        this.dbPath = process.env.DB_PATH || './database/app.db';
    }

    connect() {
        return new Promise((resolve, reject) => {
            this.db = new sqlite3.Database(this.dbPath, (err) => {
                if (err) {
                    console.error('数据库连接失败:', err.message);
                    reject(err);
                } else {
                    console.log('数据库连接成功');
                    this.setupDatabase();
                    resolve(this.db);
                }
            });
        });
    }

    setupDatabase() {
        // 启用WAL模式
        this.db.run('PRAGMA journal_mode = WAL');
        
        // 启用外键约束
        this.db.run('PRAGMA foreign_keys = ON');
        
        // 设置同步模式
        this.db.run('PRAGMA synchronous = NORMAL');
        
        // 设置缓存大小
        this.db.run('PRAGMA cache_size = 10000');
    }

    getDatabase() {
        return this.db;
    }

    close() {
        return new Promise((resolve, reject) => {
            if (this.db) {
                this.db.close((err) => {
                    if (err) {
                        console.error('关闭数据库失败:', err.message);
                        reject(err);
                    } else {
                        console.log('数据库连接已关闭');
                        resolve();
                    }
                });
            } else {
                resolve();
            }
        });
    }
}

module.exports = new DatabaseConnection();
```

**src/app.js**：
```javascript
const express = require('express');
const cors = require('cors');
const db = require('./database/connection');

const app = express();
const PORT = process.env.PORT || 3000;

// 中间件
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// 路由
app.get('/', (req, res) => {
    res.json({ message: 'SQLite应用运行中' });
});

app.get('/health', (req, res) => {
    res.json({ 
        status: 'OK', 
        timestamp: new Date().toISOString(),
        database: db.getDatabase() ? 'connected' : 'disconnected'
    });
});

// 启动服务器
async function startServer() {
    try {
        await db.connect();
        app.listen(PORT, () => {
            console.log(`服务器运行在端口 ${PORT}`);
        });
    } catch (error) {
        console.error('启动服务器失败:', error);
        process.exit(1);
    }
}

// 优雅关闭
process.on('SIGINT', async () => {
    console.log('正在关闭服务器...');
    await db.close();
    process.exit(0);
});

startServer();
```

---

## 常见安装问题解决

### 1. Node.js安装问题

**问题：node命令未找到**
```bash
# 解决方案：检查PATH环境变量
echo $PATH  # Linux/macOS
echo %PATH% # Windows

# 重新安装Node.js或手动添加PATH
```

**问题：npm权限错误**
```bash
# 解决方案：使用nvm或修改npm全局目录
mkdir ~/.npm-global
npm config set prefix '~/.npm-global'
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
```

### 2. SQLite安装问题

**问题：sqlite3命令未找到**
```bash
# 检查安装
which sqlite3  # Linux/macOS
where sqlite3  # Windows

# 重新安装或检查PATH
```

**问题：SQLite版本过低**
```bash
# 检查版本
sqlite3 --version

# 升级到最新版本
# 使用包管理器或从源码编译
```

### 3. Node.js SQLite库安装问题

**问题：编译失败**
```bash
# 安装编译工具
# Windows
npm install --global windows-build-tools

# macOS
xcode-select --install

# Linux
sudo apt install build-essential python3-dev
```

**问题：权限错误**
```bash
# 使用sudo（不推荐）
sudo npm install sqlite3

# 或修复npm权限
npm config set prefix ~/.npm-global
```

**问题：网络问题**
```bash
# 使用国内镜像
npm config set registry https://registry.npmmirror.com

# 或使用cnpm
npm install -g cnpm --registry=https://registry.npmmirror.com
cnpm install sqlite3
```

### 4. 平台特定问题

**Windows问题**：
```bash
# 安装Visual Studio Build Tools
# 或使用预编译版本
npm install sqlite3 --prebuilt
```

**macOS问题**：
```bash
# 安装Xcode Command Line Tools
xcode-select --install

# 设置编译器
export CC=clang
export CXX=clang++
```

**Linux问题**：
```bash
# 安装开发工具
sudo apt update
sudo apt install build-essential python3-dev

# 或使用预编译版本
npm install sqlite3 --prebuilt
```

---

## 环境验证

### 1. 基础环境验证

**Node.js验证**：
```bash
# 检查Node.js版本
node --version
# 输出示例：v18.17.0

# 检查npm版本
npm --version
# 输出示例：9.6.7
```

**SQLite验证**：
```bash
# 检查SQLite版本
sqlite3 --version
# 输出示例：3.44.0 2024-01-15 12:36:22
```

### 2. Node.js SQLite库验证

**sqlite3库验证**：
```javascript
// test-sqlite3.js
const sqlite3 = require('sqlite3').verbose();

console.log('SQLite3版本:', sqlite3.VERSION);
console.log('SQLite版本:', sqlite3.SQLITE_VERSION);

const db = new sqlite3.Database(':memory:', (err) => {
    if (err) {
        console.error('连接失败:', err.message);
    } else {
        console.log('SQLite3连接成功');
        
        db.run('CREATE TABLE test (id INTEGER PRIMARY KEY, name TEXT)', (err) => {
            if (err) {
                console.error('创建表失败:', err.message);
            } else {
                console.log('表创建成功');
                
                db.run('INSERT INTO test (name) VALUES (?)', ['Hello SQLite'], function(err) {
                    if (err) {
                        console.error('插入数据失败:', err.message);
                    } else {
                        console.log('数据插入成功, ID:', this.lastID);
                        
                        db.get('SELECT * FROM test WHERE id = ?', [this.lastID], (err, row) => {
                            if (err) {
                                console.error('查询失败:', err.message);
                            } else {
                                console.log('查询结果:', row);
                            }
                            
                            db.close((err) => {
                                if (err) {
                                    console.error('关闭失败:', err.message);
                                } else {
                                    console.log('数据库已关闭');
                                }
                            });
                        });
                    }
                });
            }
        });
    }
});
```

**better-sqlite3库验证**：
```javascript
// test-better-sqlite3.js
const Database = require('better-sqlite3');

console.log('Better-SQLite3版本:', require('better-sqlite3/package.json').version);

const db = new Database(':memory:');

console.log('SQLite版本:', db.pragma('user_version'));

try {
    // 创建表
    db.exec('CREATE TABLE test (id INTEGER PRIMARY KEY, name TEXT)');
    console.log('表创建成功');
    
    // 插入数据
    const insert = db.prepare('INSERT INTO test (name) VALUES (?)');
    const result = insert.run('Hello Better-SQLite3');
    console.log('数据插入成功, ID:', result.lastInsertRowid);
    
    // 查询数据
    const select = db.prepare('SELECT * FROM test WHERE id = ?');
    const row = select.get(result.lastInsertRowid);
    console.log('查询结果:', row);
    
    console.log('Better-SQLite3测试成功');
} catch (error) {
    console.error('测试失败:', error.message);
} finally {
    db.close();
}
```

### 3. 完整环境测试

**创建测试脚本**：
```javascript
// test-environment.js
const sqlite3 = require('sqlite3').verbose();
const path = require('path');
const fs = require('fs');

async function testEnvironment() {
    console.log('=== 环境测试开始 ===\n');
    
    // 1. 检查Node.js环境
    console.log('1. Node.js环境:');
    console.log(`   Node.js版本: ${process.version}`);
    console.log(`   平台: ${process.platform}`);
    console.log(`   架构: ${process.arch}`);
    console.log(`   内存使用: ${Math.round(process.memoryUsage().heapUsed / 1024 / 1024)}MB\n`);
    
    // 2. 检查SQLite3库
    console.log('2. SQLite3库:');
    console.log(`   库版本: ${sqlite3.VERSION}`);
    console.log(`   SQLite版本: ${sqlite3.SQLITE_VERSION}\n`);
    
    // 3. 测试数据库连接
    console.log('3. 数据库连接测试:');
    const testDbPath = './test.db';
    
    try {
        const db = new sqlite3.Database(testDbPath);
        
        await new Promise((resolve, reject) => {
            db.run(`
                CREATE TABLE IF NOT EXISTS test_table (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT NOT NULL,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            `, (err) => {
                if (err) reject(err);
                else resolve();
            });
        });
        
        console.log('   ✓ 数据库文件创建成功');
        console.log('   ✓ 表创建成功');
        
        // 测试插入
        await new Promise((resolve, reject) => {
            db.run('INSERT INTO test_table (name) VALUES (?)', ['测试数据'], function(err) {
                if (err) reject(err);
                else {
                    console.log(`   ✓ 数据插入成功, ID: ${this.lastID}`);
                    resolve();
                }
            });
        });
        
        // 测试查询
        await new Promise((resolve, reject) => {
            db.get('SELECT * FROM test_table WHERE id = 1', (err, row) => {
                if (err) reject(err);
                else {
                    console.log('   ✓ 数据查询成功:', row);
                    resolve();
                }
            });
        });
        
        // 关闭数据库
        await new Promise((resolve, reject) => {
            db.close((err) => {
                if (err) reject(err);
                else resolve();
            });
        });
        
        console.log('   ✓ 数据库连接关闭成功\n');
        
    } catch (error) {
        console.error('   ✗ 数据库测试失败:', error.message);
    }
    
    // 4. 清理测试文件
    try {
        if (fs.existsSync(testDbPath)) {
            fs.unlinkSync(testDbPath);
            console.log('4. 清理测试文件: ✓ 成功\n');
        }
    } catch (error) {
        console.error('4. 清理测试文件: ✗ 失败:', error.message);
    }
    
    console.log('=== 环境测试完成 ===');
}

// 运行测试
testEnvironment().catch(console.error);
```

**运行测试**：
```bash
node test-environment.js
```

**预期输出**：
```
=== 环境测试开始 ===

1. Node.js环境:
   Node.js版本: v18.17.0
   平台: darwin
   架构: x64
   内存使用: 25MB

2. SQLite3库:
   库版本: 5.1.6
   SQLite版本: 3.44.0

3. 数据库连接测试:
   ✓ 数据库文件创建成功
   ✓ 表创建成功
   ✓ 数据插入成功, ID: 1
   ✓ 数据查询成功: { id: 1, name: '测试数据', created_at: '2024-01-15 12:36:22' }
   ✓ 数据库连接关闭成功

4. 清理测试文件: ✓ 成功

=== 环境测试完成 ===
```

---

## 总结

通过本章的学习，您已经完成了Node.js和SQLite开发环境的完整搭建。现在您具备了：

1. **完整的开发环境**：Node.js、SQLite、相关工具
2. **项目结构**：标准化的项目目录和配置文件
3. **基础代码**：数据库连接和基本应用框架
4. **问题解决能力**：常见安装问题的解决方案
5. **验证方法**：环境测试和验证脚本

接下来，我们将深入学习SQLite的基本操作和CRUD功能，为实际项目开发打下坚实基础。

---

*下一章：[基本操作与CRUD示例](./03-基本操作与CRUD示例.md)*
