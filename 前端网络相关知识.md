# å‰ç«¯ç½‘ç»œç›¸å…³çŸ¥è¯†æ·±åº¦è§£æ

> åŸºäº2024å¹´æœ€æ–°æŠ€æœ¯å‘å±•çš„å‰ç«¯ç½‘ç»œçŸ¥è¯†å…¨é¢æ€»ç»“

## ç›®å½•
- [æµè§ˆå™¨è¾“å…¥URLåˆ°é¡µé¢å±•ç¤ºçš„å®Œæ•´è¿‡ç¨‹](#æµè§ˆå™¨è¾“å…¥urlåˆ°é¡µé¢å±•ç¤ºçš„å®Œæ•´è¿‡ç¨‹)
- [DNSåŸŸåè§£æç³»ç»Ÿ](#dnsåŸŸåè§£æç³»ç»Ÿ)
- [HTTPåè®®è¯¦è§£](#httpåè®®è¯¦è§£)
- [HTTPSä¸å®‰å…¨ä¼ è¾“](#httpsä¸å®‰å…¨ä¼ è¾“)
- [TCP/UDPä¼ è¾“å±‚åè®®](#tcpudpä¼ è¾“å±‚åè®®)
- [æµè§ˆå™¨ç¼“å­˜æœºåˆ¶](#æµè§ˆå™¨ç¼“å­˜æœºåˆ¶)
- [CDNå†…å®¹åˆ†å‘ç½‘ç»œ](#cdnå†…å®¹åˆ†å‘ç½‘ç»œ)
- [WebSocketå®æ—¶é€šä¿¡](#websocketå®æ—¶é€šä¿¡)
- [ç½‘ç»œæ€§èƒ½ä¼˜åŒ–](#ç½‘ç»œæ€§èƒ½ä¼˜åŒ–)
- [å®‰å…¨é˜²æŠ¤æœºåˆ¶](#å®‰å…¨é˜²æŠ¤æœºåˆ¶)

---

## æµè§ˆå™¨è¾“å…¥URLåˆ°é¡µé¢å±•ç¤ºçš„å®Œæ•´è¿‡ç¨‹

### ğŸ† å®Œæ•´æµç¨‹å›¾

```mermaid
flowchart TD
    A["ğŸ‘¤ ç”¨æˆ·è¾“å…¥ URL"] --> B["ğŸ” URLè§£æä¸éªŒè¯"]
    B --> C{"ğŸ“ æ£€æŸ¥æµè§ˆå™¨ç¼“å­˜"}
    C -->|å‘½ä¸­| D["âš¡ ç›´æ¥æ˜¾ç¤ºç¼“å­˜é¡µé¢"]
    C -->|æœªå‘½ä¸­| E["ğŸŒ DNSåŸŸåè§£æ"]
    
    E --> F["ğŸ”— å»ºç«‹TCPè¿æ¥"]
    F --> G{"ğŸ”’ HTTPS?"}
    G -->|æ˜¯| H["ğŸ”‘ TLS/SSLæ¡æ‰‹"]
    G -->|å¦| I["ğŸ“¦ æ„å»ºHTTPè¯·æ±‚"]
    H --> I
    
    I --> J["ğŸš€ å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨"]
    J --> K["ğŸ–¥ï¸ æœåŠ¡å™¨å¤„ç†è¯·æ±‚"]
    K --> L["ğŸ“¦ æ„å»ºHTTPå“åº”"]
    L --> M["ğŸ“ å“åº”è¿”å›æµè§ˆå™¨"]
    
    M --> N["ğŸ“ è§£æHTMLæ–‡æ¡£"]
    N --> O["ğŸ¨ æ„å»ºDOMæ ‘"]
    O --> P["ğŸ¨ æ„å»ºCSOMæ ‘"]
    P --> Q["ğŸŒ³ åˆå¹¶ä¸ºæ¸²æŸ“æ ‘"]
    
    Q --> R["ğŸ“ å¸ƒå±€(Layout)"]
    R --> S["ğŸ¨ ç»˜åˆ¶(Paint)"]
    S --> T["ğŸ“± åˆæˆ(Composite)"]
    T --> U["ğŸ‰ é¡µé¢æ˜¾ç¤ºå®Œæˆ"]
    
    %% å¹¶è¡ŒåŠ è½½èµ„æº
    N --> V["ğŸ–¼ï¸ åŠ è½½å›¾ç‰‡èµ„æº"]
    N --> W["ğŸ¨ åŠ è½½CSSæ ·å¼"]
    N --> X["âš™ï¸ åŠ è½½JavaScript"]
    
    V --> Q
    W --> P
    X --> Y["ğŸ“œ æ‰§è¡ŒJSè„šæœ¬"]
    Y --> Z{"DOMæ“ä½œ?"}
    Z -->|æ˜¯| O
    Z -->|å¦| U
    
    classDef user fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef network fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    classDef server fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef browser fill:#e8f5e8,stroke:#4caf50,stroke-width:2px
    classDef render fill:#fce4ec,stroke:#e91e63,stroke-width:2px
    
    class A,D user
    class B,C,E,F,G,H,I,J network
    class K,L,M server
    class N,O,P,V,W,X,Y,Z browser
    class Q,R,S,T,U render
```

### 1. URLè§£æä¸éªŒè¯

**è¾“å…¥å¤„ç†é˜¶æ®µï¼š**
```
ç”¨æˆ·è¾“å…¥: https://www.example.com/path?query=value#fragment
```

**è¯¦ç»†è§£ææµç¨‹ï¼š**

#### 1.1 URLè¯­æ³•åˆ†æ
```javascript
// æµè§ˆå™¨å†…éƒ¨URLè§£æä¼ªä»£ç 
function parseURL(inputURL) {
    const urlPattern = /^(([^:/?#]+):)?((\/\/([^/?#]*))?)([^?#]*)(\?([^#]*))?(#(.*))?$/;
    const match = inputURL.match(urlPattern);
    
    return {
        protocol: match[2] || 'http',     // https
        host: match[5] || '',             // www.example.com
        pathname: match[6] || '/',        // /path
        search: match[8] || '',           // query=value
        hash: match[10] || ''             // fragment
    };
}
```

#### 1.2 åè®®å¤„ç†æœºåˆ¶
```
HTTP/HTTPSåè®®é€‰æ‹©ï¼š
- HTTPï¼šæ˜æ–‡ä¼ è¾“ï¼Œé»˜è®¤80ç«¯å£ï¼Œæ— åŠ å¯†
- HTTPSï¼šåŠ å¯†ä¼ è¾“ï¼Œé»˜è®¤443ç«¯å£ï¼ŒTLS/SSLåŠ å¯†
- HTTP/2ï¼šäºŒè¿›åˆ¶åè®®ï¼Œå¤šè·¯å¤ç”¨ï¼ŒæœåŠ¡å™¨æ¨é€
- HTTP/3ï¼šåŸºäºQUICï¼ŒUDPä¼ è¾“ï¼Œ0-RTTè¿æ¥
```

#### 1.3 åŸŸåè§„èŒƒåŒ–
1. **IDNå¤„ç†**ï¼šå›½é™…åŒ–åŸŸåè½¬æ¢ä¸ºPunycode
2. **å¤§å°å†™ç»Ÿä¸€**ï¼šåŸŸåè½¬æ¢ä¸ºå°å†™
3. **å°¾ç‚¹å¤„ç†**ï¼šç§»é™¤æˆ–æ·»åŠ æ ¹åŸŸç‚¹
4. **å­åŸŸåè§£æ**ï¼šwwwå‰ç¼€å¤„ç†

#### 1.4 è·¯å¾„ä¸å‚æ•°å¤„ç†
```javascript
// URLç¼–ç å¤„ç†
function processURLComponents(url) {
    // è·¯å¾„ç¼–ç ï¼ˆRFC 3986ï¼‰
    const encodedPath = encodeURIComponent(url.pathname);
    
    // æŸ¥è¯¢å‚æ•°è§£æ
    const queryParams = new URLSearchParams(url.search);
    
    // é”šç‚¹å¤„ç†ï¼ˆä¸å‘é€åˆ°æœåŠ¡å™¨ï¼‰
    const fragment = url.hash.substring(1);
    
    return { encodedPath, queryParams, fragment };
}
```

**ç‰¹æ®Šå­—ç¬¦å¤„ç†è§„åˆ™ï¼š**
```
ä¿ç•™å­—ç¬¦: : / ? # [ ] @
éä¿ç•™å­—ç¬¦: A-Z a-z 0-9 - . _ ~ 
éœ€è¦ç¼–ç : ç©ºæ ¼(%20) ä¸­æ–‡å­—ç¬¦ ç‰¹æ®Šç¬¦å·
```

### 2. æµè§ˆå™¨ç¼“å­˜æ£€æŸ¥

**ç¼“å­˜æŸ¥æ‰¾é¡ºåºï¼š**
```mermaid
flowchart TD
    A["ğŸŒ ç½‘ç»œè¯·æ±‚"] --> B["ğŸ” æ£€æŸ¥ç¼“å­˜"]
    B --> C{"Service Worker Cache"}
    C -->|å‘½ä¸­| D["âœ… è¿”å›SWç¼“å­˜"]
    C -->|æœªå‘½ä¸­| E{"Memory Cache"}
    E -->|å‘½ä¸­| F["âœ… è¿”å›å†…å­˜ç¼“å­˜"]
    E -->|æœªå‘½ä¸­| G{"Disk Cache"}
    G -->|å‘½ä¸­| H["âœ… è¿”å›ç£ç›˜ç¼“å­˜"]
    G -->|æœªå‘½ä¸­| I{"Push Cache"}
    I -->|å‘½ä¸­| J["âœ… è¿”å›æ¨é€ç¼“å­˜"]
    I -->|æœªå‘½ä¸­| K["ğŸŒ å‘èµ·ç½‘ç»œè¯·æ±‚"]
    
    classDef cache fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef hit fill:#e8f5e8,stroke:#4caf50,stroke-width:2px
    classDef miss fill:#ffebee,stroke:#f44336,stroke-width:2px
    
    class C,E,G,I cache
    class D,F,H,J hit
    class K miss
```

**è¯¦ç»†æ£€æŸ¥æµç¨‹ï¼š**
```javascript
// ç¼“å­˜æ£€æŸ¥ä¼ªä»£ç 
function checkCache(url) {
    // 1. æ£€æŸ¥Service Workerç¼“å­˜
    if (serviceWorkerCache.has(url)) {
        return serviceWorkerCache.get(url);
    }
    
    // 2. æ£€æŸ¥å†…å­˜ç¼“å­˜
    if (memoryCache.has(url)) {
        return memoryCache.get(url);
    }
    
    // 3. æ£€æŸ¥ç£ç›˜ç¼“å­˜
    if (diskCache.has(url)) {
        const cached = diskCache.get(url);
        if (cached.expiry > Date.now()) {
            return cached.data;
        }
    }
    
    // 4. ç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€è¦ç½‘ç»œè¯·æ±‚
    return null;
}
```

### 3. DNSåŸŸåè§£æ

**å®Œæ•´è§£ææµç¨‹ï¼š**

#### 3.1 ç¼“å­˜æŸ¥æ‰¾å±‚æ¬¡
```javascript
// DNSç¼“å­˜æ£€æŸ¥ä¼ªä»£ç 
class DNSResolver {
    constructor() {
        this.browserCache = new Map();  // æµè§ˆå™¨ç¼“å­˜ï¼ˆ60ç§’ï¼‰
        this.osCache = new Map();       // æ“ä½œç³»ç»Ÿç¼“å­˜
        this.routerCache = new Map();   // è·¯ç”±å™¨ç¼“å­˜
        this.ispCache = new Map();      // ISPç¼“å­˜
    }
    
    async resolve(domain) {
        // 1. æµè§ˆå™¨ç¼“å­˜æ£€æŸ¥
        if (this.browserCache.has(domain)) {
            const cached = this.browserCache.get(domain);
            if (cached.expiry > Date.now()) {
                console.log('å‘½ä¸­æµè§ˆå™¨ç¼“å­˜');
                return cached.ip;
            }
        }
        
        // 2. æ“ä½œç³»ç»Ÿç¼“å­˜æ£€æŸ¥
        if (this.osCache.has(domain)) {
            console.log('å‘½ä¸­ç³»ç»Ÿç¼“å­˜');
            return this.osCache.get(domain).ip;
        }
        
        // 3. hostsæ–‡ä»¶æ£€æŸ¥
        const hostsResult = this.checkHostsFile(domain);
        if (hostsResult) {
            console.log('å‘½ä¸­hostsæ–‡ä»¶æ˜ å°„');
            return hostsResult;
        }
        
        // 4. è¿›è¡Œé€’å½’æŸ¥è¯¢
        return await this.recursiveQuery(domain);
    }
    
    checkHostsFile(domain) {
        // æ£€æŸ¥ C:\Windows\System32\drivers\etc\hosts (åœ¨Windowsç³»ç»Ÿä¸­)
        const hostsEntries = {
            'localhost': '127.0.0.1',
            'example.local': '192.168.1.100'
        };
        return hostsEntries[domain] || null;
    }
}
```

#### 3.2 é€’å½’æŸ¥è¯¢è¯¦ç»†è¿‡ç¨‹
```mermaid
flowchart TD
    A["ğŸ“± ç”¨æˆ·è¾“å…¥ www.example.com"] --> B["ğŸ  æœ¬åœ°DNSæœåŠ¡å™¨<br/>8.8.8.8"]
    B --> C{{"ğŸŒ æ ¹DNSæœåŠ¡å™¨<br/>(.)"}}
    C --> D["ğŸ“ è¿”å›.com TLDæœåŠ¡å™¨åœ°å€"]
    D --> E{{"ğŸ¬ é¡¶çº§åŸŸåæœåŠ¡å™¨<br/>(.com)"}}
    E --> F["ğŸ“ è¿”å›example.comæƒå¨æœåŠ¡å™¨åœ°å€"]
    F --> G{{"âš™ï¸ æƒå¨DNSæœåŠ¡å™¨<br/>(example.com)"}}
    G --> H["âœ… è¿”å›www.example.comçš„Aè®°å½•"]
    H --> I["ğŸ¯ æœ€ç»ˆIPåœ°å€: 192.0.2.1"]
    
    classDef client fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef dns fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    classDef result fill:#e8f5e8,stroke:#4caf50,stroke-width:2px
    
    class A,B client
    class C,E,G dns
    class D,F,H,I result
```

**é€’å½’è§£æå®ç°ï¼š**
```javascript
async function recursiveQuery(domain) {
    // æ­¥éª¤1ï¼šæŸ¥è¯¢æ ¹DNSæœåŠ¡å™¨
    const rootServers = [
        '198.41.0.4',    // a.root-servers.net
        '199.9.14.201',  // b.root-servers.net
        '192.33.4.12'    // c.root-servers.net
    ];
    
    let response = await queryDNS(rootServers[0], domain, 'NS');
    
    // æ­¥éª¤2ï¼šæŸ¥è¯¢TLDæœåŠ¡å™¨(.com)
    const tldServers = response.authority; // [æ¥è‡ªæ ¹æœåŠ¡å™¨çš„TLDåœ°å€]
    response = await queryDNS(tldServers[0], domain, 'NS');
    
    // æ­¥éª¤3ï¼šæŸ¥è¯¢æƒå¨æœåŠ¡å™¨
    const authServers = response.authority; // [æ¥è‡ªTLDçš„æƒå¨æœåŠ¡å™¨åœ°å€]
    response = await queryDNS(authServers[0], domain, 'A');
    
    return response.answer[0].ip; // è¿”å›æœ€ç»ˆIPåœ°å€
}
```

#### 3.3 DNSè®°å½•ç±»å‹æ·±åº¦è§£æ

**Aè®°å½•ï¼ˆIPv4åœ°å€æ˜ å°„ï¼‰**
```dns
www.example.com.    3600    IN    A    192.0.2.1

å­—æ®µè¯´æ˜ï¼š
- www.example.com.: å®Œæ•´åŸŸåï¼ˆFQDNï¼‰
- 3600: TTLï¼ˆç”Ÿå­˜æ—¶é—´ï¼Œç§’ï¼‰
- IN: Internetç±»åˆ«
- A: è®°å½•ç±»å‹
- 192.0.2.1: IPv4åœ°å€
```

**AAAAè®°å½•ï¼ˆIPv6åœ°å€æ˜ å°„ï¼‰**
```dns
www.example.com.    3600    IN    AAAA    2001:db8:85a3::8a2e:370:7334

ç”¨é€”ï¼š
- æ”¯æŒIPv6è®¿é—®
- æä¾›æ›´å¤§åœ°å€ç©ºé—´
- æé«˜ç½‘ç»œæ€§èƒ½
```

**CNAMEè®°å½•ï¼ˆåˆ«åæ˜ å°„ï¼‰**
```dns
www.example.com.    3600    IN    CNAME    example.com.

ä½¿ç”¨åœºæ™¯ï¼š
- CDNåŠ é€Ÿï¼šwww.example.com -> cdn.provider.com
- è´Ÿè½½å‡è¡¡ï¼šapi.example.com -> lb.example.com
- æœåŠ¡è¿ç§»ï¼šold.example.com -> new.example.com

é™åˆ¶ï¼š
- CNAMEè®°å½•ä¸èƒ½ä¸å…¶ä»–è®°å½•ç±»å‹å…±å­˜
- æœ€å¤š5å±‚CNAMEè·³è½¬é˜²æ­¢æ­»å¾ªç¯
```

**MXè®°å½•ï¼ˆé‚®ä»¶äº¤æ¢ï¼‰**
```dns
example.com.    3600    IN    MX    10    mail1.example.com.
example.com.    3600    IN    MX    20    mail2.example.com.

ä¼˜å…ˆçº§è§„åˆ™ï¼š
- æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
- ç›¸åŒä¼˜å…ˆçº§éšæœºé€‰æ‹©ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
- æ”¯æŒé‚®ä»¶æœåŠ¡å™¨å¤‡ä»½
```

**TXTè®°å½•ï¼ˆæ–‡æœ¬ä¿¡æ¯ï¼‰**
```dns
example.com.    3600    IN    TXT    "v=spf1 include:_spf.google.com ~all"
example.com.    3600    IN    TXT    "google-site-verification=abc123def456"

åº”ç”¨åœºæ™¯ï¼š
1. SPFè®°å½•ï¼šé˜²æ­¢é‚®ä»¶ä¼ªé€ 
2. DKIMç­¾åï¼šé‚®ä»¶èº«ä»½éªŒè¯
3. åŸŸåéªŒè¯ï¼šè¯æ˜åŸŸåæ‰€æœ‰æƒ
4. å®‰å…¨ç­–ç•¥ï¼šCSPã€HSTSç­‰
```

#### 3.4 DNSå®‰å…¨æœºåˆ¶

**DNSSECï¼ˆDNSå®‰å…¨æ‰©å±•ï¼‰**
```javascript
// DNSSECéªŒè¯æµç¨‹
class DNSSECValidator {
    validateChain(domain) {
        // 1. æ£€æŸ¥æ ¹åŸŸç­¾å
        const rootKey = this.getTrustAnchor();
        
        // 2. éªŒè¯.comçš„DSè®°å½•
        const comDS = this.verifyDS('.com', rootKey);
        
        // 3. éªŒè¯example.comçš„DSè®°å½•
        const exampleDS = this.verifyDS('example.com', comDS.key);
        
        // 4. éªŒè¯www.example.comçš„Aè®°å½•
        const aRecord = this.verifyRRSIG('www.example.com', 'A', exampleDS.key);
        
        return aRecord.verified;
    }
    
    verifyRRSIG(domain, type, publicKey) {
        // RRSIGç­¾åéªŒè¯é€»è¾‘
        const rrsig = this.getRRSIG(domain, type);
        const signature = rrsig.signature;
        const data = this.canonicalizeData(rrsig.data);
        
        return crypto.verify(publicKey, data, signature);
    }
}
```

**DNS over HTTPS (DoH)å®ç°ï¼š**
```javascript
class SecureDNSResolver {
    constructor() {
        this.dohServers = [
            'https://cloudflare-dns.com/dns-query',
            'https://dns.google/dns-query',
            'https://dns.quad9.net/dns-query'
        ];
    }
    
    async resolve(domain, type = 'A') {
        const query = {
            name: domain,
            type: type,
            cd: false,  // checking disabled
            do: true    // DNSSEC OK
        };
        
        try {
            const response = await fetch(this.dohServers[0], {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/dns-json',
                    'Accept': 'application/dns-json'
                },
                body: JSON.stringify(query)
            });
            
            const result = await response.json();
            
            if (result.Status === 0) { // NOERROR
                return this.parseAnswer(result.Answer);
            } else {
                throw new Error(`DNS query failed: ${result.Status}`);
            }
        } catch (error) {
            console.error('DoH query failed:', error);
            // å›é€€åˆ°ä¼ ç»ŸDNS
            return this.fallbackToTraditionalDNS(domain, type);
        }
    }
    
    parseAnswer(answers) {
        return answers.map(answer => ({
            name: answer.name,
            type: answer.type,
            ttl: answer.TTL,
            data: answer.data
        }));
    }
}
```

**DNSè®°å½•ç±»å‹ï¼š**
```
Aè®°å½•ï¼š    åŸŸå â†’ IPv4åœ°å€
AAAAè®°å½•ï¼š  åŸŸå â†’ IPv6åœ°å€
CNAMEè®°å½•ï¼š åŸŸå â†’ åˆ«ååŸŸå
MXè®°å½•ï¼š    é‚®ä»¶äº¤æ¢è®°å½•
TXTè®°å½•ï¼š   æ–‡æœ¬è®°å½•ï¼ˆå¦‚SPFã€DKIMï¼‰
NSè®°å½•ï¼š    åç§°æœåŠ¡å™¨è®°å½•
```

### 4. å»ºç«‹TCPè¿æ¥

**ä¸‰æ¬¡æ¡æ‰‹è¯¦ç»†è¿‡ç¨‹ï¼š**

```
å®¢æˆ·ç«¯                           æœåŠ¡å™¨
  |                               |
  |  SYN seq=x               â†’   |  ç¬¬ä¸€æ¬¡æ¡æ‰‹
  |                               |
  |  â† SYN+ACK seq=y,ack=x+1     |  ç¬¬äºŒæ¬¡æ¡æ‰‹
  |                               |
  |  ACK ack=y+1             â†’   |  ç¬¬ä¸‰æ¡æ‰‹
  |                               |
  |      è¿æ¥å»ºç«‹æˆåŠŸ               |
```

**æ¯æ¬¡æ¡æ‰‹çš„ä½œç”¨ï¼š**
1. **ç¬¬ä¸€æ¬¡æ¡æ‰‹**ï¼šå®¢æˆ·ç«¯è¯æ˜è‡ªå·±çš„å‘é€èƒ½åŠ›æ­£å¸¸
2. **ç¬¬äºŒæ¬¡æ¡æ‰‹**ï¼šæœåŠ¡å™¨è¯æ˜è‡ªå·±çš„æ¥æ”¶å’Œå‘é€èƒ½åŠ›æ­£å¸¸
3. **ç¬¬ä¸‰æ¬¡æ¡æ‰‹**ï¼šå®¢æˆ·ç«¯è¯æ˜è‡ªå·±çš„æ¥æ”¶èƒ½åŠ›æ­£å¸¸ï¼Œç¡®è®¤æœåŠ¡å™¨çš„å‘é€èƒ½åŠ›

**TCPè¿æ¥å‚æ•°ï¼š**
```
æœ€å¤§æ®µå¤§å°(MSS): 1460å­—èŠ‚
çª—å£å¤§å°: 65535å­—èŠ‚
è¶…æ—¶é‡ä¼ : æŒ‡æ•°é€€é¿ç®—æ³•
æ‹¥å¡æ§åˆ¶: æ…¢å¯åŠ¨ + æ‹¥å¡é¿å…
```

### 5. TLS/SSLæ¡æ‰‹ï¼ˆHTTPSï¼‰

**å®Œæ•´TLS 1.3æ¡æ‰‹æµç¨‹ï¼š**

```
å®¢æˆ·ç«¯                           æœåŠ¡å™¨
  |                               |
  |  ClientHello              â†’  |  1. å®¢æˆ·ç«¯é—®å€™
  |  - æ”¯æŒçš„å¯†ç å¥—ä»¶               |
  |  - éšæœºæ•°1                    |
  |  - æ”¯æŒçš„TLSç‰ˆæœ¬               |
  |                               |
  |  â† ServerHello                |  2. æœåŠ¡å™¨å“åº”
  |  - é€‰æ‹©çš„å¯†ç å¥—ä»¶               |
  |  - éšæœºæ•°2                    |
  |  - æœåŠ¡å™¨è¯ä¹¦                  |
  |  - æœåŠ¡å™¨å¯†é’¥äº¤æ¢               |
  |                               |
  |  å®¢æˆ·ç«¯å¯†é’¥äº¤æ¢            â†’   |  3. å¯†é’¥äº¤æ¢
  |  ChangeCipherSpec             |
  |  Finished                     |
  |                               |
  |  â† ChangeCipherSpec           |  4. æ¡æ‰‹å®Œæˆ
  |  â† Finished                  |
  |                               |
  |      åŠ å¯†é€šä¿¡å¼€å§‹               |
```

**è¯ä¹¦éªŒè¯è¿‡ç¨‹ï¼š**
1. **è¯ä¹¦é“¾éªŒè¯**ï¼šéªŒè¯ä»ç½‘ç«™è¯ä¹¦åˆ°æ ¹CAçš„å®Œæ•´é“¾
2. **æœ‰æ•ˆæœŸæ£€æŸ¥**ï¼šç¡®è®¤è¯ä¹¦åœ¨æœ‰æ•ˆæœŸå†…
3. **åŸŸååŒ¹é…**ï¼šéªŒè¯è¯ä¹¦ä¸­çš„åŸŸåä¸è®¿é—®åŸŸåä¸€è‡´
4. **åŠé”€æ£€æŸ¥**ï¼šé€šè¿‡OCSPæˆ–CRLæ£€æŸ¥è¯ä¹¦æ˜¯å¦è¢«åŠé”€
5. **ç­¾åéªŒè¯**ï¼šéªŒè¯CAçš„æ•°å­—ç­¾å

### 6. HTTPè¯·æ±‚æ„å»º

**HTTP/1.1è¯·æ±‚æŠ¥æ–‡ç»“æ„ï¼š**
```http
GET /path?query=value HTTP/1.1
Host: www.example.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.9,en;q=0.8
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Cache-Control: max-age=0
If-None-Match: "abc123"
If-Modified-Since: Wed, 21 Oct 2024 07:28:00 GMT
```

**è¯·æ±‚å¤´è¯¦è§£ï¼š**
- **Host**ï¼šç›®æ ‡ä¸»æœºåï¼ˆHTTP/1.1å¿…éœ€ï¼‰
- **User-Agent**ï¼šæµè§ˆå™¨æ ‡è¯†ä¿¡æ¯
- **Accept**ï¼šå¯æ¥å—çš„å†…å®¹ç±»å‹
- **Accept-Encoding**ï¼šæ”¯æŒçš„å‹ç¼©ç®—æ³•
- **Connection**ï¼šè¿æ¥ç®¡ç†ï¼ˆkeep-alive/closeï¼‰
- **Cache-Control**ï¼šç¼“å­˜æ§åˆ¶æŒ‡ä»¤
- **Authorization**ï¼šèº«ä»½è®¤è¯ä¿¡æ¯
- **Referer**ï¼šæ¥æºé¡µé¢URL

### 7. æœåŠ¡å™¨å¤„ç†è¯·æ±‚

**æœåŠ¡å™¨ç«¯å¤„ç†æµç¨‹ï¼š**

#### 7.1 WebæœåŠ¡å™¨å±‚
```
Nginx/Apache â†’ è§£æè¯·æ±‚ â†’ è·¯ç”±åŒ¹é… â†’ é™æ€/åŠ¨æ€åˆ†å‘
```

#### 7.2 åº”ç”¨æœåŠ¡å™¨å±‚
```
Node.js/Java/Python â†’ ä¸šåŠ¡é€»è¾‘å¤„ç† â†’ æ•°æ®åº“æŸ¥è¯¢ â†’ å“åº”æ„å»º
```

#### 7.3 æ•°æ®å¤„ç†
```sql
-- ç¤ºä¾‹æ•°æ®åº“æŸ¥è¯¢
SELECT title, content, created_at 
FROM articles 
WHERE id = ? AND status = 'published'
```

**å“åº”æ„å»ºè¿‡ç¨‹ï¼š**
```javascript
// æœåŠ¡å™¨å“åº”æ„å»ºç¤ºä¾‹
function buildResponse(request) {
    const response = {
        statusCode: 200,
        headers: {
            'Content-Type': 'text/html; charset=utf-8',
            'Content-Encoding': 'gzip',
            'Cache-Control': 'public, max-age=3600',
            'ETag': '"def456"',
            'Last-Modified': new Date().toUTCString(),
            'X-Content-Type-Options': 'nosniff',
            'X-Frame-Options': 'DENY',
            'X-XSS-Protection': '1; mode=block'
        },
        body: compressedHtmlContent
    };
    return response;
}
```

### 8. HTTPå“åº”ä¼ è¾“

**HTTP/1.1å“åº”æŠ¥æ–‡ç»“æ„ï¼š**
```http
HTTP/1.1 200 OK
Date: Thu, 22 Oct 2024 15:30:00 GMT
Server: nginx/1.20.2
Content-Type: text/html; charset=utf-8
Content-Length: 12345
Content-Encoding: gzip
Cache-Control: public, max-age=3600
ETag: "def456"
Last-Modified: Wed, 21 Oct 2024 07:28:00 GMT
Vary: Accept-Encoding
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
Strict-Transport-Security: max-age=31536000; includeSubDomains
Connection: keep-alive

<!DOCTYPE html>
<html>
<head>
    <title>Example Page</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <h1>Welcome</h1>
    <script src="/js/app.js"></script>
</body>
</html>
```

**å“åº”çŠ¶æ€ç åˆ†ç±»ï¼š**
```
1xx ä¿¡æ¯æ€§çŠ¶æ€ç ï¼š
- 100 Continue: ç»§ç»­è¯·æ±‚
- 101 Switching Protocols: åˆ‡æ¢åè®®

2xx æˆåŠŸçŠ¶æ€ç ï¼š
- 200 OK: è¯·æ±‚æˆåŠŸ
- 201 Created: èµ„æºåˆ›å»ºæˆåŠŸ
- 204 No Content: æˆåŠŸä½†æ— å†…å®¹
- 206 Partial Content: éƒ¨åˆ†å†…å®¹ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰

3xx é‡å®šå‘çŠ¶æ€ç ï¼š
- 301 Moved Permanently: æ°¸ä¹…é‡å®šå‘
- 302 Found: ä¸´æ—¶é‡å®šå‘
- 304 Not Modified: èµ„æºæœªä¿®æ”¹
- 307 Temporary Redirect: ä¸´æ—¶é‡å®šå‘ï¼ˆä¿æŒæ–¹æ³•ï¼‰

4xx å®¢æˆ·ç«¯é”™è¯¯ï¼š
- 400 Bad Request: è¯·æ±‚è¯­æ³•é”™è¯¯
- 401 Unauthorized: éœ€è¦è®¤è¯
- 403 Forbidden: æ‹’ç»è®¿é—®
- 404 Not Found: èµ„æºä¸å­˜åœ¨
- 405 Method Not Allowed: æ–¹æ³•ä¸å…è®¸
- 429 Too Many Requests: è¯·æ±‚è¿‡å¤š

5xx æœåŠ¡å™¨é”™è¯¯ï¼š
- 500 Internal Server Error: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
- 502 Bad Gateway: ç½‘å…³é”™è¯¯
- 503 Service Unavailable: æœåŠ¡ä¸å¯ç”¨
- 504 Gateway Timeout: ç½‘å…³è¶…æ—¶
```

### 9. æµè§ˆå™¨æ¥æ”¶å’Œè§£æ

**èµ„æºä¸‹è½½ä¼˜å…ˆçº§ï¼š**
```
1. å…³é”®èµ„æºï¼ˆHTMLã€Critical CSSï¼‰
2. é¢„åŠ è½½èµ„æºï¼ˆ<link rel="preload">ï¼‰
3. æ ·å¼è¡¨æ–‡ä»¶
4. åŒæ­¥è„šæœ¬
5. å¼‚æ­¥è„šæœ¬å’Œå›¾ç‰‡
6. å»¶è¿ŸåŠ è½½èµ„æº
```

**HTMLè§£æè¿‡ç¨‹ï¼š**
```javascript
// HTMLè§£ææµç¨‹
function parseHTML(htmlContent) {
    // 1. è¯æ³•åˆ†æï¼ˆTokenizationï¼‰
    const tokens = tokenizer.parse(htmlContent);
    
    // 2. æ„å»ºDOMæ ‘
    const domTree = domBuilder.build(tokens);
    
    // 3. æ ·å¼è®¡ç®—
    const cssRules = styleCalculator.compute(domTree);
    
    // 4. å¸ƒå±€è®¡ç®—
    const layoutTree = layoutCalculator.calculate(domTree, cssRules);
    
    // 5. ç»˜åˆ¶å‡†å¤‡
    const paintLayers = paintPreparer.prepare(layoutTree);
    
    return {
        dom: domTree,
        css: cssRules,
        layout: layoutTree,
        paint: paintLayers
    };
}
```

### 10. èµ„æºåŠ è½½ä¸æ¸²æŸ“

**æµè§ˆå™¨æ¸²æŸ“ç®¡é“ï¼š**
```
HTML â†’ DOMæ ‘
  â†“
CSS â†’ CSSOMæ ‘
  â†“
DOM + CSSOM â†’ æ¸²æŸ“æ ‘
  â†“
å¸ƒå±€ï¼ˆLayout/Reflowï¼‰
  â†“
ç»˜åˆ¶ï¼ˆPaintï¼‰
  â†“
åˆæˆï¼ˆCompositeï¼‰
```

**å…³é”®æ¸²æŸ“è·¯å¾„ä¼˜åŒ–ï¼š**
```html
<!-- å…³é”®CSSå†…è” -->
<style>
.critical { font-size: 16px; color: #333; }
</style>

<!-- é¢„åŠ è½½å…³é”®èµ„æº -->
<link rel="preload" href="/fonts/main.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/css/critical.css" as="style">

<!-- å¼‚æ­¥åŠ è½½éå…³é”®CSS -->
<link rel="preload" href="/css/non-critical.css" as="style" onload="this.onload=null;this.rel='stylesheet'">

<!-- å»¶è¿ŸåŠ è½½è„šæœ¬ -->
<script defer src="/js/app.js"></script>
<script async src="/js/analytics.js"></script>
```

---

## DNSåŸŸåè§£æç³»ç»Ÿ

### DNSç³»ç»Ÿæ¶æ„

**åˆ†å±‚ç»“æ„ï¼š**
```mermaid
flowchart TD
    A["ğŸŒ æ ¹åŸŸåæœåŠ¡å™¨ (.)"] --> B["ğŸ¬ é¡¶çº§åŸŸåæœåŠ¡å™¨"]
    B --> C["(.com)"]
    B --> D["(.org)"]
    B --> E["(.cn)"]
    B --> F["(.net)"]
    
    C --> G["ğŸ¢ äºŒçº§åŸŸåæœåŠ¡å™¨"]
    G --> H["example.com"]
    G --> I["google.com"]
    G --> J["github.com"]
    
    H --> K["ğŸ  ä¸‰çº§åŸŸåæœåŠ¡å™¨"]
    K --> L["www.example.com"]
    K --> M["api.example.com"]
    K --> N["cdn.example.com"]
    
    classDef root fill:#ffebee,stroke:#d32f2f,stroke-width:3px
    classDef tld fill:#e8eaf6,stroke:#3f51b5,stroke-width:2px
    classDef domain fill:#e0f2f1,stroke:#00796b,stroke-width:2px
    classDef subdomain fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    
    class A root
    class B,C,D,E,F tld
    class G,H,I,J domain
    class K,L,M,N subdomain
```

**DNSè®°å½•ç±»å‹è¯¦è§£ï¼š**

#### Aè®°å½•ï¼ˆIPv4åœ°å€ï¼‰
```
www.example.com.    IN    A    192.168.1.100
TTL: 3600ç§’
ç”¨é€”: å°†åŸŸåæŒ‡å‘IPv4åœ°å€
```

#### AAAAè®°å½•ï¼ˆIPv6åœ°å€ï¼‰
```
www.example.com.    IN    AAAA    2001:db8::1
TTL: 3600ç§’
ç”¨é€”: å°†åŸŸåæŒ‡å‘IPv6åœ°å€
```

#### CNAMEè®°å½•ï¼ˆåˆ«åï¼‰
```
www.example.com.    IN    CNAME    example.com.
TTL: 3600ç§’
ç”¨é€”: åŸŸååˆ«åï¼Œä¸èƒ½ä¸å…¶ä»–è®°å½•ç±»å‹å…±å­˜
```

#### MXè®°å½•ï¼ˆé‚®ä»¶äº¤æ¢ï¼‰
```
example.com.    IN    MX    10    mail.example.com.
ä¼˜å…ˆçº§: 10ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
ç”¨é€”: æŒ‡å®šé‚®ä»¶æœåŠ¡å™¨
```

#### TXTè®°å½•ï¼ˆæ–‡æœ¬ä¿¡æ¯ï¼‰
```
example.com.    IN    TXT    "v=spf1 include:_spf.google.com ~all"
ç”¨é€”: SPFã€DKIMã€åŸŸåéªŒè¯ç­‰
```

### DNSæŸ¥è¯¢ç±»å‹

#### é€’å½’æŸ¥è¯¢
```mermaid
sequenceDiagram
    participant C as ğŸ“± å®¢æˆ·ç«¯
    participant L as ğŸ  æœ¬åœ°DNSæœåŠ¡å™¨
    participant R as ğŸŒ æ ¹DNS
    participant T as ğŸ¬ TLD
    participant A as âš™ï¸ æƒå¨DNS
    
    Note over C,A: é€’å½’æŸ¥è¯¢ - å®¢æˆ·ç«¯åªå‘èµ·ä¸€æ¬¡è¯·æ±‚
    
    C->>L: ğŸ” æŸ¥è¯¢ www.example.com
    L->>R: æŸ¥è¯¢æ ¹DNS
    R->>L: è¿”å›.com TLDåœ°å€
    L->>T: æŸ¥è¯¢TLD
    T->>L: è¿”å›æƒå¨DNSåœ°å€
    L->>A: æŸ¥è¯¢æƒå¨DNS
    A->>L: è¿”å›IPåœ°å€
    L->>C: ğŸ¯ è¿”å›æœ€ç»ˆç»“æœ
```

#### è¿­ä»£æŸ¥è¯¢
```mermaid
sequenceDiagram
    participant C as ğŸ“± å®¢æˆ·ç«¯
    participant R as ğŸŒ æ ¹DNS
    participant T as ğŸ¬ TLD
    participant A as âš™ï¸ æƒå¨DNS
    
    Note over C,A: è¿­ä»£æŸ¥è¯¢ - å®¢æˆ·ç«¯å¤šæ¬¡æŸ¥è¯¢ä¸åŒDNSæœåŠ¡å™¨
    
    C->>R: ğŸ” æŸ¥è¯¢ www.example.com
    R->>C: è¿”å›.com TLDåœ°å€
    C->>T: æŸ¥è¯¢TLD
    T->>C: è¿”å›æƒå¨DNSåœ°å€
    C->>A: æŸ¥è¯¢æƒå¨DNS
    A->>C: ğŸ¯ è¿”å›æœ€ç»ˆIPåœ°å€
```

### DNSç¼“å­˜æœºåˆ¶

**ç¼“å­˜å±‚çº§ï¼š**
```javascript
// DNSç¼“å­˜å±‚çº§ç¤ºä¾‹
const dnsCache = {
    // æµè§ˆå™¨ç¼“å­˜ï¼ˆ60ç§’ï¼‰
    browser: {
        'www.example.com': {
            ip: '192.168.1.100',
            ttl: 60,
            timestamp: Date.now()
        }
    },
    
    // æ“ä½œç³»ç»Ÿç¼“å­˜ï¼ˆç³»ç»Ÿé…ç½®ï¼‰
    os: {
        'www.example.com': {
            ip: '192.168.1.100',
            ttl: 3600,
            timestamp: Date.now()
        }
    },
    
    // æœ¬åœ°DNSæœåŠ¡å™¨ç¼“å­˜ï¼ˆTTLé…ç½®ï¼‰
    localDNS: {
        'www.example.com': {
            ip: '192.168.1.100',
            ttl: 86400,
            timestamp: Date.now()
        }
    }
};
```

### DNSå®‰å…¨

#### DNSåŠ«æŒé˜²æŠ¤
```javascript
// DNS over HTTPS (DoH) å®ç°
class SecureDNS {
    constructor() {
        this.dohServer = 'https://cloudflare-dns.com/dns-query';
    }
    
    async resolve(domain) {
        const query = {
            name: domain,
            type: 'A'
        };
        
        const response = await fetch(this.dohServer, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/dns-json'
            },
            body: JSON.stringify(query)
        });
        
        return response.json();
    }
}
```

#### DNSSECéªŒè¯
```
åŸŸåç­¾åéªŒè¯æµç¨‹ï¼š
1. æƒå¨DNSæœåŠ¡å™¨ä½¿ç”¨ç§é’¥å¯¹DNSè®°å½•ç­¾å
2. å…¬é’¥é€šè¿‡DSè®°å½•å‘å¸ƒåˆ°çˆ¶åŸŸ
3. é€’å½’è§£æå™¨éªŒè¯ç­¾åé“¾çš„å®Œæ•´æ€§
4. ç¡®ä¿DNSå“åº”æœªè¢«ç¯¡æ”¹
```

---

## HTTPåè®®è¯¦è§£

### HTTP/1.1ç‰¹æ€§

#### æŒä¹…è¿æ¥ï¼ˆKeep-Aliveï¼‰
```http
# è¯·æ±‚å¤´
Connection: keep-alive
Keep-Alive: timeout=5, max=100

# å“åº”å¤´
Connection: keep-alive
Keep-Alive: timeout=5, max=100
```

**ä¼˜åŠ¿ï¼š**
- å‡å°‘TCPè¿æ¥å»ºç«‹çš„å¼€é”€
- é™ä½æœåŠ¡å™¨èµ„æºæ¶ˆè€—
- æé«˜é¡µé¢åŠ è½½é€Ÿåº¦

**é—®é¢˜ï¼š**
- é˜Ÿå¤´é˜»å¡ï¼ˆHead-of-Line Blockingï¼‰
- å¹¶å‘é™åˆ¶ï¼ˆæµè§ˆå™¨å¯¹åŒä¸€åŸŸåé€šå¸¸é™åˆ¶6ä¸ªè¿æ¥ï¼‰

#### ç®¡é“åŒ–ï¼ˆPipeliningï¼‰
```mermaid
gantt
    title HTTP/1.1 ç®¡é“åŒ– vs ä¼ ç»Ÿæ¨¡å¼
    dateFormat X
    axisFormat %s
    
    section ä¼ ç»Ÿæ¨¡å¼
    è¯·æ±‚1       :active, req1, 0, 1
    å“åº”1       :resp1, after req1, 1
    è¯·æ±‚2       :req2, after resp1, 1  
    å“åº”2       :resp2, after req2, 1
    è¯·æ±‚3       :req3, after resp2, 1
    å“åº”3       :resp3, after req3, 1
    
    section ç®¡é“åŒ–æ¨¡å¼
    è¯·æ±‚1       :active, preq1, 0, 1
    è¯·æ±‚2       :preq2, 1, 1
    è¯·æ±‚3       :preq3, 2, 1
    å“åº”1       :presp1, 3, 1
    å“åº”2       :presp2, 4, 1
    å“åº”3       :presp3, 5, 1
```

**æ€§èƒ½å¯¹æ¯”ï¼š**
- **ä¼ ç»Ÿæ¨¡å¼**ï¼šä¸²è¡Œå¤„ç†ï¼Œæ€»æ—¶é—´ = 6ä¸ªæ—¶é—´å•ä½
- **ç®¡é“åŒ–æ¨¡å¼**ï¼šå¹¶è¡Œå‘é€ï¼Œæ€»æ—¶é—´ = 6ä¸ªæ—¶é—´å•ä½ï¼ˆä½†ç½‘ç»œåˆ©ç”¨ç‡æ›´é«˜ï¼‰

### HTTP/2åè®®

#### äºŒè¿›åˆ¶åˆ†å¸§
```
HTTP/1.1 æ–‡æœ¬åè®®ï¼š
GET /index.html HTTP/1.1\r\n
Host: example.com\r\n
\r\n

HTTP/2 äºŒè¿›åˆ¶å¸§ï¼š
[Length][Type][Flags][Stream ID][Payload]
[   3  ][ 1 ][ 1  ][    4   ][   N   ]
```

#### å¤šè·¯å¤ç”¨
```javascript
// HTTP/2 å¤šè·¯å¤ç”¨ç¤ºä¾‹
class HTTP2Connection {
    constructor() {
        this.streams = new Map();
        this.nextStreamId = 1;
    }
    
    createStream(request) {
        const streamId = this.nextStreamId;
        this.nextStreamId += 2; // å®¢æˆ·ç«¯ä½¿ç”¨å¥‡æ•°ID
        
        const stream = {
            id: streamId,
            state: 'idle',
            request: request,
            response: null,
            headers: new Map(),
            data: []
        };
        
        this.streams.set(streamId, stream);
        return stream;
    }
    
    sendFrame(streamId, type, flags, payload) {
        const frame = {
            length: payload.length,
            type: type,
            flags: flags,
            streamId: streamId,
            payload: payload
        };
        
        this.connection.write(this.encodeFrame(frame));
    }
}
```

#### æœåŠ¡å™¨æ¨é€
```javascript
// æœåŠ¡å™¨æ¨é€å®ç°
app.get('/index.html', (req, res) => {
    // æ¨é€CSSæ–‡ä»¶
    res.push('/css/style.css', {
        request: {
            'accept': 'text/css'
        },
        response: {
            'content-type': 'text/css'
        }
    });
    
    // æ¨é€JavaScriptæ–‡ä»¶
    res.push('/js/app.js', {
        request: {
            'accept': 'application/javascript'
        },
        response: {
            'content-type': 'application/javascript'
        }
    });
    
    // å‘é€HTMLå“åº”
    res.send(htmlContent);
});
```

#### å¤´éƒ¨å‹ç¼©ï¼ˆHPACKï¼‰
```
HTTP/1.1 é‡å¤å¤´éƒ¨ï¼š
GET /page1 HTTP/1.1
Host: example.com
User-Agent: Mozilla/5.0...
Accept: text/html...

GET /page2 HTTP/1.1
Host: example.com          # é‡å¤
User-Agent: Mozilla/5.0... # é‡å¤
Accept: text/html...       # é‡å¤

HTTP/2 HPACKå‹ç¼©ï¼š
é™æ€è¡¨ + åŠ¨æ€è¡¨ + å“ˆå¤«æ›¼ç¼–ç 
å¤´éƒ¨å¤§å°å‡å°‘çº¦85%
```

### HTTP/3åè®®æ·±åº¦è§£æ

#### QUICåè®®æ ¸å¿ƒç‰¹æ€§

**1. åŸºäºUDPçš„ä¼ è¾“å±‚**
```
ä¼ ç»Ÿæ¨¡å¼ï¼š
HTTP/1.1: TCP + TLS 1.2 = 3-4 RTT
HTTP/2:   TCP + TLS 1.2 = 3-4 RTT

HTTP/3æ¨¡å¼ï¼š
HTTP/3:   UDP + QUIC + TLS 1.3 = 1-2 RTT
é¦–æ¬¡è¿æ¥ï¼š1 RTT
é‡è¿ï¼š0 RTTï¼ˆä½¿ç”¨ç¼“å­˜çš„è¿æ¥çŠ¶æ€ï¼‰
```

**2. 0-RTTè¿æ¥å»ºç«‹**
```javascript
// QUIC 0-RTTå®ç°åŸç†
class QUICConnection {
    constructor() {
        this.cachedParams = null;
        this.sessionTicket = null;
    }
    
    async connect(server, useCache = false) {
        if (useCache && this.sessionTicket) {
            // 0-RTT: ç›´æ¥å‘é€åº”ç”¨æ•°æ®
            const earlyData = this.buildEarlyDataPacket();
            await this.sendPacket(server, earlyData);
            
            console.log('0-RTTè¿æ¥å·²å»ºç«‹');
            return 'connected';
        } else {
            // 1-RTT: æ­£å¸¸æ¡æ‰‹æµç¨‹
            const clientHello = this.buildClientHello();
            const serverResponse = await this.sendPacket(server, clientHello);
            
            // ç¼“å­˜ä¼šè¯ä¿¡æ¯ä¾›ä¸‹æ¬¡ä½¿ç”¨
            this.sessionTicket = serverResponse.sessionTicket;
            this.cachedParams = serverResponse.transportParams;
            
            console.log('1-RTTè¿æ¥å·²å»ºç«‹');
            return 'connected';
        }
    }
    
    buildEarlyDataPacket() {
        return {
            type: 'early_data',
            sessionTicket: this.sessionTicket,
            applicationData: 'GET / HTTP/1.1\r\nHost: example.com\r\n\r\n'
        };
    }
}
```

**3. æµçº§åˆ«å¤šè·¯å¤ç”¨**
```javascript
// QUICæµç®¡ç†
class QUICStreamManager {
    constructor() {
        this.streams = new Map();
        this.nextStreamId = 0;
    }
    
    createStream(priority = 'normal') {
        const streamId = this.nextStreamId;
        this.nextStreamId += 4; // å®¢æˆ·ç«¯ä½¿ç”¨å¶æ•°ID
        
        const stream = {
            id: streamId,
            priority: priority,
            state: 'open',
            sendBuffer: [],
            receiveBuffer: [],
            flowControlWindow: 65536 // 64KB
        };
        
        this.streams.set(streamId, stream);
        return stream;
    }
    
    // æµçº§åˆ«éš”ç¦» - ä¸€ä¸ªæµçš„é”™è¯¯ä¸å½±å“å…¶ä»–æµ
    handleStreamError(streamId, error) {
        const stream = this.streams.get(streamId);
        if (stream) {
            stream.state = 'error';
            stream.error = error;
            
            // åªé‡ä¼ å½“å‰æµçš„æ•°æ®
            this.retransmitStream(streamId);
            
            console.log(`æµ ${streamId} å‘ç”Ÿé”™è¯¯ï¼Œä½†ä¸å½±å“å…¶ä»–æµ`);
        }
    }
    
    retransmitStream(streamId) {
        const stream = this.streams.get(streamId);
        if (stream && stream.sendBuffer.length > 0) {
            // é‡ä¼ æœªç¡®è®¤çš„æ•°æ®åŒ…
            console.log(`é‡ä¼ æµ ${streamId} çš„æ•°æ®`);
        }
    }
}
```

**4. å†…ç½®åŠ å¯†ä¸è¿æ¥è¿ç§»**
```javascript
// QUICè¿æ¥è¿ç§»æ”¯æŒ
class QUICMigration {
    constructor() {
        this.connectionId = this.generateConnectionId();
        this.currentPath = null;
        this.alternatePaths = [];
    }
    
    // ç½‘ç»œåˆ‡æ¢æ—¶çš„è¿æ¥è¿ç§»
    async migrateConnection(newInterface) {
        console.log('æ£€æµ‹åˆ°ç½‘ç»œæ¥å£å˜åŒ–ï¼Œå¼€å§‹è¿æ¥è¿ç§»');
        
        // 1. åœ¨æ–°æ¥å£ä¸Šå‘é€æ¢æµ‹åŒ…
        const probePacket = {
            type: 'path_challenge',
            connectionId: this.connectionId,
            challenge: this.generateChallenge()
        };
        
        try {
            const response = await this.sendOnNewPath(newInterface, probePacket);
            
            if (response.type === 'path_response') {
                // 2. æ–°è·¯å¾„å¯ç”¨ï¼Œåˆ‡æ¢è¿æ¥
                this.currentPath = newInterface;
                console.log('è¿æ¥è¿ç§»æˆåŠŸï¼Œç»§ç»­ä¼ è¾“æ•°æ®');
                
                // 3. é€šçŸ¥åº”ç”¨å±‚è¿æ¥ä»ç„¶æœ‰æ•ˆ
                this.notifyApplicationLayerMigrationComplete();
            }
        } catch (error) {
            console.log('è¿æ¥è¿ç§»å¤±è´¥ï¼Œä¿æŒåŸè¿æ¥');
        }
    }
    
    generateConnectionId() {
        // ç”Ÿæˆå”¯ä¸€è¿æ¥IDï¼Œç”¨äºè¯†åˆ«è¿æ¥è€Œéå››å…ƒç»„
        return crypto.randomBytes(8).toString('hex');
    }
}
```

#### HTTP/3æ€§èƒ½ä¼˜åŠ¿

**1. æ¶ˆé™¤é˜Ÿå¤´é˜»å¡**
```
HTTP/2 TCPé˜Ÿå¤´é˜»å¡é—®é¢˜ï¼š
æµA: [1][2][X][4][5]  // åŒ…3ä¸¢å¤±
æµB: [1][2][3][4][5]  // å—æµAå½±å“ï¼Œå…¨éƒ¨é˜»å¡

HTTP/3 QUICè§£å†³æ–¹æ¡ˆï¼š
æµA: [1][2][X][4][5]  // åªé‡ä¼ æµAçš„åŒ…3
æµB: [1][2][3][4][5]  // æ­£å¸¸ä¼ è¾“ï¼Œä¸å—å½±å“
```

**2. æ›´é«˜æ•ˆçš„æ‹¥å¡æ§åˆ¶**
```javascript
// QUICæ‹¥å¡æ§åˆ¶ç®—æ³•
class QUICCongestionControl {
    constructor() {
        this.congestionWindow = 10; // åˆå§‹æ‹¥å¡çª—å£
        this.slowStartThreshold = 65535;
        this.rtt = 100; // åˆå§‹ RTT (ms)
        this.algorithm = 'cubic'; // é»˜è®¤ä½¿ç”¨ CUBIC
    }
    
    onPacketAcked(packetSize, ackTime) {
        // æ›´æ–° RTT
        this.updateRTT(ackTime);
        
        if (this.congestionWindow < this.slowStartThreshold) {
            // æ…¢å¯åŠ¨é˜¶æ®µï¼šæŒ‡æ•°å¢é•¿
            this.congestionWindow += packetSize;
        } else {
            // æ‹¥å¡é¿å…é˜¶æ®µï¼šQUICä½¿ç”¨æ”¹è¿›CUBICç®—æ³•
            this.cubicUpdate(packetSize);
        }
    }
    
    onPacketLost() {
        // æ£€æµ‹åˆ°ä¸¢åŒ…
        this.slowStartThreshold = this.congestionWindow / 2;
        this.congestionWindow = this.slowStartThreshold;
        
        console.log(`æ£€æµ‹åˆ°ä¸¢åŒ…ï¼Œæ‹¥å¡çª—å£è°ƒæ•´ä¸º: ${this.congestionWindow}`);
    }
    
    cubicUpdate(packetSize) {
        // CUBICç®—æ³•å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
        const timeSinceLastLoss = Date.now() - this.lastLossTime;
        const k = Math.cbrt(this.lastMaxWindow * 0.7 / 0.4); // CUBICå‚æ•°
        
        const cubicWindow = 0.4 * Math.pow(timeSinceLastLoss - k, 3) + this.lastMaxWindow;
        this.congestionWindow = Math.max(this.congestionWindow + packetSize / this.congestionWindow, cubicWindow);
    }
}
```

**3. æ›´å¥½çš„æµæ§åˆ¶**
```javascript
// QUICæµæ§åˆ¶æœºåˆ¶
class QUICFlowControl {
    constructor() {
        this.connectionWindow = 1048576; // 1MB è¿æ¥çº§æµæ§åˆ¶
        this.streamWindows = new Map();   // æµçº§æµæ§åˆ¶
    }
    
    canSendData(streamId, dataSize) {
        const streamWindow = this.streamWindows.get(streamId) || 65536;
        
        // æ£€æŸ¥è¿æ¥çº§å’Œæµçº§æµæ§åˆ¶
        if (this.connectionWindow >= dataSize && streamWindow >= dataSize) {
            // æ›´æ–°çª—å£å¤§å°
            this.connectionWindow -= dataSize;
            this.streamWindows.set(streamId, streamWindow - dataSize);
            return true;
        }
        
        return false;
    }
    
    updateWindow(streamId, windowUpdate) {
        // æ¥æ”¶åˆ°çª—å£æ›´æ–°æ¶ˆæ¯
        if (streamId === 0) {
            // è¿æ¥çº§çª—å£æ›´æ–°
            this.connectionWindow += windowUpdate;
        } else {
            // æµçº§çª—å£æ›´æ–°
            const currentWindow = this.streamWindows.get(streamId) || 0;
            this.streamWindows.set(streamId, currentWindow + windowUpdate);
        }
    }
}
```

### HTTPæ–¹æ³•è¯¦è§£

#### GETè¯·æ±‚
```http
GET /api/users?page=1&limit=10 HTTP/1.1
Host: api.example.com
Accept: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

ç‰¹ç‚¹ï¼š
- å¹‚ç­‰æ“ä½œ
- å¯ç¼“å­˜
- å‚æ•°åœ¨URLä¸­
- é•¿åº¦é™åˆ¶ï¼ˆçº¦2048å­—ç¬¦ï¼‰
```

#### POSTè¯·æ±‚
```http
POST /api/users HTTP/1.1
Host: api.example.com
Content-Type: application/json
Content-Length: 95
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

{
  "name": "John Doe",
  "email": "john@example.com",
  "role": "user"
}

ç‰¹ç‚¹ï¼š
- éå¹‚ç­‰æ“ä½œ
- ä¸å¯ç¼“å­˜
- å‚æ•°åœ¨è¯·æ±‚ä½“ä¸­
- æ— é•¿åº¦é™åˆ¶
```

#### PUTè¯·æ±‚ï¼ˆå¹‚ç­‰æ›´æ–°ï¼‰
```http
PUT /api/users/123 HTTP/1.1
Host: api.example.com
Content-Type: application/json
If-Match: "abc123"

{
  "name": "John Smith",
  "email": "john.smith@example.com",
  "role": "admin"
}
```

#### PATCHè¯·æ±‚ï¼ˆéƒ¨åˆ†æ›´æ–°ï¼‰
```http
PATCH /api/users/123 HTTP/1.1
Host: api.example.com
Content-Type: application/json-patch+json

[
  { "op": "replace", "path": "/name", "value": "John Smith" },
  { "op": "add", "path": "/phone", "value": "+1234567890" }
]
```

#### DELETEè¯·æ±‚
```http
DELETE /api/users/123 HTTP/1.1
Host: api.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## HTTPSä¸å®‰å…¨ä¼ è¾“

### TLS 1.3æ¡æ‰‹è¿‡ç¨‹

**1-RTTæ¡æ‰‹æµç¨‹ï¼š**
```mermaid
sequenceDiagram
    participant C as ğŸ–¥ï¸ å®¢æˆ·ç«¯
    participant S as ğŸ–±ï¸ æœåŠ¡å™¨
    
    Note over C,S: TLS 1.3 ä¸€æ¬¡å¾€è¿”æ—¶é—´(1-RTT)æ¡æ‰‹
    
    C->>S: ğŸ”‘ ClientHello + KeyShare
    Note right of S: åŒ…å«æ”¯æŒçš„å¯†ç å¥—ä»¶ã€éšæœºæ•°ã€å¯†é’¥å…±äº«
    
    S->>C: ğŸ“œ ServerHello + Certificate + CertificateVerify + Finished
    Note left of C: é€‰æ‹©å¯†ç å¥—ä»¶ã€è¯ä¹¦é“¾ã€æ•°å­—ç­¾åã€å®Œæˆæ¶ˆæ¯
    
    Note over C,S: ğŸ”’ å¯¹ç§°å¯†é’¥å·²ç”Ÿæˆï¼Œå¯ä»¥å¼€å§‹åŠ å¯†é€šä¿¡
    
    C->>S: ğŸ“¦ [Application Data] (åŠ å¯†æ•°æ®)
    S->>C: ğŸ“¦ [Application Data] (åŠ å¯†æ•°æ®)
    
    Note over C,S: ğŸ‰ å®‰å…¨é€šä¿¡å»ºç«‹ï¼
```

**ä¸»è¦æ”¹è¿›ï¼š**
- 1-RTTæ¡æ‰‹ï¼ˆç›¸æ¯”TLS 1.2çš„2-RTTï¼‰
- ç§»é™¤ä¸å®‰å…¨å¯†ç å¥—ä»¶
- å¼ºåˆ¶å‰å‘ä¿å¯†æ€§
- 0-RTTæ—©æœŸæ•°æ®æ”¯æŒ

### æ•°å­—è¯ä¹¦éªŒè¯

**éªŒè¯æ­¥éª¤ï¼š**
1. **æœ‰æ•ˆæœŸæ£€æŸ¥**ï¼šè¯ä¹¦åœ¨æœ‰æ•ˆæœŸå†…
2. **åŸŸååŒ¹é…**ï¼šCNæˆ–SANå­—æ®µåŒ¹é…è®¿é—®åŸŸå
3. **è¯ä¹¦é“¾éªŒè¯**ï¼šä»ç½‘ç«™è¯ä¹¦åˆ°æ ¹CAçš„å®Œæ•´é“¾
4. **æ’¤é”€æ£€æŸ¥**ï¼šé€šè¿‡OCSPæˆ–CRLæ£€æŸ¥
5. **ç­¾åéªŒè¯**ï¼šéªŒè¯CAçš„æ•°å­—ç­¾å

---

## TCP/UDPä¼ è¾“å±‚åè®®

### TCPä¸‰æ¬¡æ¡æ‰‹è¯¦è§£

```mermaid
sequenceDiagram
    participant C as ğŸ–¥ï¸ å®¢æˆ·ç«¯
    participant S as ğŸ–±ï¸ æœåŠ¡å™¨
    
    Note over C,S: TCPä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥
    
    C->>S: ğŸš€ SYN seq=x (ç¬¬ä¸€æ¬¡æ¡æ‰‹)
    Note right of S: è¯æ˜å®¢æˆ·ç«¯å‘é€èƒ½åŠ›æ­£å¸¸
    
    S->>C: ğŸ¤ SYN+ACK seq=y,ack=x+1 (ç¬¬äºŒæ¬¡æ¡æ‰‹)
    Note left of C: è¯æ˜æœåŠ¡å™¨æ”¶å‘èƒ½åŠ›æ­£å¸¸
    
    C->>S: âœ… ACK ack=y+1 (ç¬¬ä¸‰æ¬¡æ¡æ‰‹)
    Note right of S: è¯æ˜å®¢æˆ·ç«¯æ¥æ”¶èƒ½åŠ›æ­£å¸¸
    
    Note over C,S: ğŸ‰ TCPè¿æ¥å»ºç«‹æˆåŠŸï¼
```

**ä¸ºä»€ä¹ˆéœ€è¦ä¸‰æ¬¡ï¼Ÿ**
- é˜²æ­¢æ—§çš„SYNè¯·æ±‚å»ºç«‹é”™è¯¯è¿æ¥
- ç¡®è®¤åŒæ–¹æ”¶å‘èƒ½åŠ›æ­£å¸¸
- é¿å…åŠè¿æ¥æ”»å‡»

### TCPå››æ¬¡æŒ¥æ‰‹

```mermaid
sequenceDiagram
    participant C as ğŸ–¥ï¸ å®¢æˆ·ç«¯
    participant S as ğŸ–±ï¸ æœåŠ¡å™¨
    
    Note over C,S: TCPå››æ¬¡æŒ¥æ‰‹å…³é—­è¿æ¥
    
    C->>S: ğŸ›‘ FIN (å®¢æˆ·ç«¯è¯·æ±‚å…³é—­)
    Note right of S: è¿›å…¥FIN-WAIT-1çŠ¶æ€
    
    S->>C: âœ… ACK (æœåŠ¡å™¨ç¡®è®¤å…³é—­)
    Note left of C: è¿›å…¥CLOSE-WAITçŠ¶æ€
    Note right of S: è¿›å…¥FIN-WAIT-2çŠ¶æ€
    
    S->>C: ğŸ›‘ FIN (æœåŠ¡å™¨è¯·æ±‚å…³é—­)
    Note left of C: è¿›å…¥LAST-ACKçŠ¶æ€
    
    C->>S: âœ… ACK (å®¢æˆ·ç«¯æœ€ç»ˆç¡®è®¤)
    Note right of S: è¿›å…¥TIME-WAITçŠ¶æ€
    Note left of C: è¿›å…¥CLOSEDçŠ¶æ€
    
    Note over C: ç­‰å¾…2MSLåè¿›å…¥CLOSEDçŠ¶æ€
    Note over C,S: ğŸ‰ è¿æ¥å®Œå…¨å…³é—­ï¼
```

**TIME-WAITçŠ¶æ€ä½œç”¨ï¼š**
- ç¡®ä¿ACKè¢«æ­£ç¡®æ¥æ”¶
- é˜²æ­¢æ—§è¿æ¥æ•°æ®å¹²æ‰°æ–°è¿æ¥

### TCPæ‹¥å¡æ§åˆ¶

**å››ç§ç®—æ³•ï¼š**
1. **æ…¢å¯åŠ¨**ï¼šæŒ‡æ•°å¢é•¿æ¢æµ‹å¸¦å®½
2. **æ‹¥å¡é¿å…**ï¼šçº¿æ€§å¢é•¿ç»´æŒç¨³å®š
3. **å¿«é‡ä¼ **ï¼šæ”¶åˆ°3ä¸ªé‡å¤ACKç«‹å³é‡ä¼ 
4. **å¿«æ¢å¤**ï¼šé¿å…æ…¢å¯åŠ¨çš„æ€§èƒ½æŸå¤±

---

## æµè§ˆå™¨ç¼“å­˜æœºåˆ¶

### ç¼“å­˜åˆ†ç±»

**æŒ‰ä½ç½®åˆ†ç±»ï¼š**
```
1. Service Worker Cache (æœ€é«˜ä¼˜å…ˆçº§)
2. Memory Cache (å†…å­˜ç¼“å­˜)
3. Disk Cache (ç£ç›˜ç¼“å­˜)  
4. Push Cache (HTTP/2æ¨é€ç¼“å­˜)
```

**æŒ‰ç±»å‹åˆ†ç±»ï¼š**
```
1. å¼ºç¼“å­˜ (ä¸å‘è¯·æ±‚)
2. åå•†ç¼“å­˜ (å‘è¯·æ±‚éªŒè¯)
```

### å¼ºç¼“å­˜æœºåˆ¶

**Cache-ControlæŒ‡ä»¤ï¼š**
```http
Cache-Control: public, max-age=3600, must-revalidate

æŒ‡ä»¤è¯´æ˜ï¼š
- public: å¯è¢«ä»»ä½•ç¼“å­˜å­˜å‚¨
- private: åªèƒ½è¢«æµè§ˆå™¨ç¼“å­˜
- max-age: ç¼“å­˜æœ‰æ•ˆæœŸ(ç§’)
- no-cache: å¿…é¡»éªŒè¯åä½¿ç”¨
- no-store: ä¸å¾—ç¼“å­˜
- must-revalidate: è¿‡æœŸåå¿…é¡»éªŒè¯
```

### åå•†ç¼“å­˜æœºåˆ¶

**ETagéªŒè¯ï¼š**
```http
# é¦–æ¬¡è¯·æ±‚å“åº”
ETag: "abc123"

# å†æ¬¡è¯·æ±‚
If-None-Match: "abc123"

# æœåŠ¡å™¨å“åº”
HTTP/1.1 304 Not Modified  # æœªä¿®æ”¹
# æˆ–
HTTP/1.1 200 OK            # å·²ä¿®æ”¹ï¼Œè¿”å›æ–°å†…å®¹
ETag: "def456"
```

---

## CDNå†…å®¹åˆ†å‘ç½‘ç»œ

### CDNå·¥ä½œåŸç†

**è¯·æ±‚æµç¨‹ï¼š**
```mermaid
flowchart TD
    A["ğŸ‘¤ ç”¨æˆ·è¯·æ±‚ www.example.com"] --> B["ğŸŒ DNSè§£æ"]
    B --> C{{"ğŸ¯ å…¨å±€è´Ÿè½½å‡è¡¡(GSLB)"}}
    C --> D["ğŸ“ åœ°ç†ä½ç½®åˆ†æ"]
    C --> E["ğŸ“Š ç½‘ç»œè´¨é‡æ£€æµ‹"]
    C --> F["âš–ï¸ è´Ÿè½½æƒ…å†µè¯„ä¼°"]
    
    D --> G["ğŸ“ é€‰æ‹©æœ€ä¼˜CDNèŠ‚ç‚¹"]
    E --> G
    F --> G
    
    G --> H{{"ğŸ’¾ CDNè¾¹ç¼˜èŠ‚ç‚¹"}}
    H --> I{"ğŸ“ æ£€æŸ¥ç¼“å­˜"}
    I -->|å‘½ä¸­| J["âš¡ ç›´æ¥è¿”å›ç¼“å­˜å†…å®¹"]
    I -->|æœªå‘½ä¸­| K["ğŸŒ å›æºè·å–"]
    K --> L["ğŸ’¾ ç¼“å­˜åˆ°CDN"]
    L --> M["ğŸ“¦ è¿”å›å†…å®¹ç»™ç”¨æˆ·"]
    J --> M
    
    classDef user fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef dns fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    classDef cdn fill:#e8f5e8,stroke:#4caf50,stroke-width:2px
    classDef cache fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    
    class A user
    class B,C,D,E,F,G dns
    class H,K,L cdn
    class I,J,M cache
```

### CDNä¼˜åŒ–ç­–ç•¥

**1. èµ„æºä¼˜åŒ–ï¼š**
- å›¾ç‰‡å‹ç¼©ä¸æ ¼å¼è½¬æ¢
- CSS/JSå‹ç¼©ä¸åˆå¹¶
- Gzip/Brotliå‹ç¼©

**2. æ™ºèƒ½è·¯ç”±ï¼š**
- åœ°ç†ä½ç½®å°±è¿‘åˆ†é…
- ç½‘ç»œè´¨é‡æ£€æµ‹
- è´Ÿè½½å‡è¡¡

---

## WebSocket å®æ—¶é€šä¿¡æ·±åº¦è§£æ

### WebSocket è¿æ¥å»ºç«‹è¿‡ç¨‹

#### 1. HTTP å‡çº§åè®®æ¡æ‰‹
```http
# å®¢æˆ·ç«¯å‘èµ·å‡çº§è¯·æ±‚
GET /chat HTTP/1.1
Host: example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13
Sec-WebSocket-Protocol: chat, superchat
Origin: https://example.com

# æœåŠ¡å™¨å“åº”
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
Sec-WebSocket-Protocol: chat
```

#### 2. WebSocket å®‰å…¨éªŒè¯
```javascript
// WebSocket å®‰å…¨éªŒè¯æœºåˆ¶
function validateWebSocketHandshake(request) {
    const websocketKey = request.headers['sec-websocket-key'];
    const websocketVersion = request.headers['sec-websocket-version'];
    
    // 1. éªŒè¯ WebSocket ç‰ˆæœ¬
    if (websocketVersion !== '13') {
        throw new Error('ä¸æ”¯æŒçš„ WebSocket ç‰ˆæœ¬');
    }
    
    // 2. éªŒè¯ Sec-WebSocket-Key
    if (!websocketKey || websocketKey.length !== 24) {
        throw new Error('æ— æ•ˆçš„ WebSocket Key');
    }
    
    // 3. ç”Ÿæˆ Sec-WebSocket-Accept
    const crypto = require('crypto');
    const magicString = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';
    const acceptKey = crypto
        .createHash('sha1')
        .update(websocketKey + magicString)
        .digest('base64');
    
    return acceptKey;
}
```

### é«˜çº§ WebSocket å®ç°

#### 1. å¸¦æœ‰é‡è¿å’Œå¿ƒè·³çš„ WebSocket å®¢æˆ·ç«¯
```javascript
class RobustWebSocket {
    constructor(url, options = {}) {
        this.url = url;
        this.options = {
            reconnectInterval: 1000,
            maxReconnectAttempts: 10,
            heartbeatInterval: 30000,
            messageQueueSize: 100,
            protocols: [],
            ...options
        };
        
        this.ws = null;
        this.reconnectAttempts = 0;
        this.messageQueue = [];
        this.heartbeatTimer = null;
        this.reconnectTimer = null;
        this.isConnected = false;
        
        this.eventListeners = {
            open: [],
            message: [],
            error: [],
            close: []
        };
        
        this.connect();
    }
    
    connect() {
        try {
            console.log(`è¿æ¥ WebSocket: ${this.url}`);
            
            this.ws = new WebSocket(this.url, this.options.protocols);
            
            this.ws.onopen = (event) => {
                console.log('WebSocket è¿æ¥å·²å»ºç«‹');
                this.isConnected = true;
                this.reconnectAttempts = 0;
                
                // å‘é€ç¼“å­˜çš„æ¶ˆæ¯
                this.flushMessageQueue();
                
                // å¯åŠ¨å¿ƒè·³æ£€æµ‹
                this.startHeartbeat();
                
                // è§¦å‘ç›‘å¬å™¨
                this.emit('open', event);
            };
            
            this.ws.onmessage = (event) => {
                const message = this.parseMessage(event.data);
                
                // å¤„ç†å¿ƒè·³å“åº”
                if (message.type === 'pong') {
                    console.log('æ”¶åˆ°å¿ƒè·³å“åº”');
                    return;
                }
                
                this.emit('message', message);
            };
            
            this.ws.onerror = (error) => {
                console.error('WebSocket é”™è¯¯:', error);
                this.emit('error', error);
            };
            
            this.ws.onclose = (event) => {
                console.log('WebSocket è¿æ¥å…³é—­:', event.code, event.reason);
                this.isConnected = false;
                this.stopHeartbeat();
                
                this.emit('close', event);
                
                // å°è¯•é‡è¿
                if (this.shouldReconnect(event.code)) {
                    this.scheduleReconnect();
                }
            };
            
        } catch (error) {
            console.error('åˆ›å»º WebSocket å¤±è´¥:', error);
            this.scheduleReconnect();
        }
    }
    
    send(data, priority = 'normal') {
        const message = {
            data: data,
            timestamp: Date.now(),
            priority: priority,
            id: this.generateMessageId()
        };
        
        if (this.isConnected && this.ws.readyState === WebSocket.OPEN) {
            try {
                this.ws.send(JSON.stringify(message));
                console.log('æ¶ˆæ¯å·²å‘é€:', message.id);
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                this.queueMessage(message);
            }
        } else {
            this.queueMessage(message);
        }
    }
    
    startHeartbeat() {
        this.stopHeartbeat();
        
        this.heartbeatTimer = setInterval(() => {
            if (this.isConnected) {
                const pingMessage = {
                    type: 'ping',
                    timestamp: Date.now()
                };
                
                try {
                    this.ws.send(JSON.stringify(pingMessage));
                    console.log('å‘é€å¿ƒè·³åŒ…');
                } catch (error) {
                    console.error('å‘é€å¿ƒè·³åŒ…å¤±è´¥:', error);
                }
            }
        }, this.options.heartbeatInterval);
    }
    
    stopHeartbeat() {
        if (this.heartbeatTimer) {
            clearInterval(this.heartbeatTimer);
            this.heartbeatTimer = null;
        }
    }
    
    scheduleReconnect() {
        if (this.reconnectAttempts >= this.options.maxReconnectAttempts) {
            console.log('è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿');
            return;
        }
        
        this.reconnectAttempts++;
        console.log(`å°è¯•é‡è¿ï¼Œç¬¬ ${this.reconnectAttempts} æ¬¡`);
        
        this.reconnectTimer = setTimeout(() => {
            this.connect();
        }, this.options.reconnectInterval);
    }
    
    shouldReconnect(code) {
        // 1000: æ­£å¸¸å…³é—­
        // 1001: å»å¾€å¦ä¸€ä¸ªæœåŠ¡å™¨
        // 1002: åè®®é”™è¯¯
        // 1003: æ— æ³•æ¥å—çš„æ•°æ®
        // 1005: æœªè®¾ç½®çŠ¶æ€ç 
        // 1006: å…³é—­è¿æ¥å¼‚å¸¸
        // 1007: ä¸æ”¯æŒçš„æ•°æ®ç±»å‹
        // 1008: è¿åç­–ç•¥
        // 1009: æ¶ˆæ¯è¿‡å¤§
        // 1010: ä¸æ”¯æŒçš„æ‰©å±•
        // 1011: æœåŠ¡å™¨é”™è¯¯
        // 1012: æœåŠ¡é‡å¯
        // 1013: ä¸´æ—¶é‡å®šå‘
        // 1014: æ— æ³•æ¥å—çš„æ•°æ®ç±»å‹
        // 1015: TLSæ¡æ‰‹å¤±è´¥
        
        // é€šå¸¸æƒ…å†µä¸‹ï¼Œé™¤äº†æ­£å¸¸å…³é—­ï¼ˆ1000ï¼‰å¤–ï¼Œéƒ½åº”è¯¥å°è¯•é‡è¿
        return code !== 1000;
    }
    
    parseMessage(data) {
        try {
            return JSON.parse(data);
        } catch (error) {
            console.error('è§£ææ¶ˆæ¯å¤±è´¥:', error);
            return null;
        }
    }
    
    queueMessage(message) {
        if (this.messageQueue.length >= this.options.messageQueueSize) {
            console.log('æ¶ˆæ¯é˜Ÿåˆ—å·²æ»¡ï¼Œä¸¢å¼ƒæ¶ˆæ¯:', message.id);
            return;
        }
        
        this.messageQueue.push(message);
        console.log('æ¶ˆæ¯å·²åŠ å…¥é˜Ÿåˆ—:', message.id);
    }
    
    flushMessageQueue() {
        if (this.messageQueue.length === 0) return;
        
        this.messageQueue.forEach(message => {
            this.send(message.data, message.priority);
        });
        
        this.messageQueue = [];
    }
    
    generateMessageId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
    }
    
    on(event, listener) {
        if (this.eventListeners[event]) {
            this.eventListeners[event].push(listener);
        }
    }
    
    emit(event, data) {
        if (this.eventListeners[event]) {
            this.eventListeners[event].forEach(listener => listener(data));
        }
    }
}

```

#### 2. WebSocket æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**æ¶ˆæ¯å‹ç¼©ä¸æ‰¹å¤„ç†ï¼š**
```javascript
class OptimizedWebSocket extends RobustWebSocket {
    constructor(url, options = {}) {
        super(url, options);
        this.messageBatch = [];
        this.batchTimer = null;
        this.compressionEnabled = options.compression || false;
    }
    
    // æ‰¹é‡å‘é€æ¶ˆæ¯ä»¥å‡å°‘ç½‘ç»œå¼€é”€
    batchSend(messages) {
        this.messageBatch.push(...messages);
        
        if (!this.batchTimer) {
            this.batchTimer = setTimeout(() => {
                this.flushBatch();
            }, 50); // 50ms æ‰¹å¤„ç†çª—å£
        }
    }
    
    flushBatch() {
        if (this.messageBatch.length === 0) return;
        
        const batchMessage = {
            type: 'batch',
            messages: this.messageBatch,
            compressed: this.compressionEnabled
        };
        
        let payload = JSON.stringify(batchMessage);
        
        // å¯ç”¨å‹ç¼©
        if (this.compressionEnabled && payload.length > 1024) {
            payload = this.compress(payload);
        }
        
        super.send(payload);
        
        this.messageBatch = [];
        this.batchTimer = null;
    }
    
    compress(data) {
        // ä½¿ç”¨ Compression Streams APIï¼ˆå¦‚æœæ”¯æŒï¼‰
        if ('CompressionStream' in window) {
            const stream = new CompressionStream('gzip');
            // å®ç°å‹ç¼©é€»è¾‘
            return data; // ç®€åŒ–ç¤ºä¾‹
        }
        return data;
    }
}
```

### WebSocket ä¸ä¼ ç»Ÿè½®è¯¢å¯¹æ¯”

**æ€§èƒ½å¯¹æ¯”åˆ†æï¼š**
```
çŸ­è½®è¯¢ (Short Polling):
- å®¢æˆ·ç«¯å®šæœŸå‘é€HTTPè¯·æ±‚
- æœåŠ¡å™¨ç«‹å³å“åº”ï¼ˆæœ‰æ— æ•°æ®éƒ½å“åº”ï¼‰
- ç½‘ç»œå¼€é”€ï¼šé«˜ï¼ˆæ¯æ¬¡éƒ½æœ‰HTTPå¤´ï¼‰
- å®æ—¶æ€§ï¼šå·®ï¼ˆå–å†³äºè½®è¯¢é—´éš”ï¼‰
- æœåŠ¡å™¨è´Ÿè½½ï¼šé«˜

é•¿è½®è¯¢ (Long Polling):
- å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¿æŒè¿æ¥
- æœ‰æ•°æ®æ—¶æ‰å“åº”ï¼Œæ— æ•°æ®æ—¶è¶…æ—¶
- ç½‘ç»œå¼€é”€ï¼šä¸­ç­‰
- å®æ—¶æ€§ï¼šè¾ƒå¥½
- æœåŠ¡å™¨è´Ÿè½½ï¼šä¸­ç­‰ï¼ˆéœ€è¦ä¿æŒè¿æ¥ï¼‰

WebSocket:
- ä¸€æ¬¡æ¡æ‰‹å»ºç«‹æŒä¹…è¿æ¥
- åŒå‘å®æ—¶é€šä¿¡
- ç½‘ç»œå¼€é”€ï¼šæœ€ä½ï¼ˆåªæœ‰æ•°æ®å¸§ï¼‰
- å®æ—¶æ€§ï¼šæœ€å¥½
- æœåŠ¡å™¨è´Ÿè½½ï¼šæœ€ä½ï¼ˆå¤ç”¨è¿æ¥ï¼‰
```

---

## é«˜çº§ç½‘ç»œæ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

### èµ„æºåŠ è½½ä¼˜åŒ–

#### 1. èµ„æºæç¤ºå’Œé¢„åŠ è½½
```html
<!-- é¢„è¿æ¥ï¼šæå‰å»ºç«‹TCP/TLSè¿æ¥ -->
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://api.example.com">

<!-- DNSé¢„è§£æï¼šæå‰è¿›è¡ŒDNSæŸ¥è¯¢ -->
<link rel="dns-prefetch" href="//cdn.example.com">
<link rel="dns-prefetch" href="//analytics.google.com">

<!-- èµ„æºé¢„åŠ è½½ï¼šé«˜ä¼˜å…ˆçº§ä¸‹è½½å…³é”®èµ„æº -->
<link rel="preload" href="/css/critical.css" as="style">
<link rel="preload" href="/js/app.js" as="script">
<link rel="preload" href="/fonts/main.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/images/hero.webp" as="image">

<!-- é¡µé¢é¢„è·å–ï¼šåœ¨ç”¨æˆ·å¯èƒ½è®¿é—®å‰é¢„åŠ è½½ -->
<link rel="prefetch" href="/page2.html">
<link rel="prefetch" href="/api/data.json">

<!-- æ¨¡å—é¢„åŠ è½½ï¼šES6æ¨¡å—é¢„åŠ è½½ -->
<link rel="modulepreload" href="/js/module.js">
```

#### 2. æ™ºèƒ½èµ„æºåŠ è½½ç­–ç•¥
```javascript
// è‡ªé€‚åº”èµ„æºåŠ è½½ç®¡ç†å™¨
class AdaptiveResourceLoader {
    constructor() {
        this.connectionQuality = this.detectConnectionQuality();
        this.deviceMemory = navigator.deviceMemory || 4;
        this.hardwareConcurrency = navigator.hardwareConcurrency || 4;
    }
    
    detectConnectionQuality() {
        const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        
        if (!connection) return 'unknown';
        
        const effectiveType = connection.effectiveType;
        const downlink = connection.downlink;
        const rtt = connection.rtt;
        
        if (effectiveType === '4g' && downlink > 10) {
            return 'fast';
        } else if (effectiveType === '3g' || downlink > 1.5) {
            return 'medium';
        } else {
            return 'slow';
        }
    }
    
    async loadResources() {
        const strategy = this.getLoadingStrategy();
        
        switch (strategy) {
            case 'aggressive':
                await this.aggressiveLoading();
                break;
            case 'balanced':
                await this.balancedLoading();
                break;
            case 'conservative':
                await this.conservativeLoading();
                break;
        }
    }
    
    getLoadingStrategy() {
        if (this.connectionQuality === 'fast' && this.deviceMemory >= 8) {
            return 'aggressive';
        } else if (this.connectionQuality === 'medium' || this.deviceMemory >= 4) {
            return 'balanced';
        } else {
            return 'conservative';
        }
    }
    
    async aggressiveLoading() {
        // é«˜é€Ÿç½‘ç»œ + é«˜æ€§èƒ½è®¾å¤‡ï¼šç«‹å³åŠ è½½æ‰€æœ‰èµ„æº
        const resources = [
            '/js/app.js',
            '/css/style.css',
            '/images/hero.webp',
            '/api/initial-data.json'
        ];
        
        await Promise.all(resources.map(url => this.preloadResource(url)));
        console.log('æ¿€è¿›åŠ è½½ç­–ç•¥ï¼šæ‰€æœ‰èµ„æºå·²é¢„åŠ è½½');
    }
    
    async balancedLoading() {
        // ä¸­ç­‰ç½‘ç»œï¼šä¼˜å…ˆåŠ è½½å…³é”®èµ„æº
        const criticalResources = ['/css/critical.css', '/js/core.js'];
        const nonCriticalResources = ['/js/analytics.js', '/css/animations.css'];
        
        await Promise.all(criticalResources.map(url => this.preloadResource(url)));
        
        // å»¶è¿ŸåŠ è½½éå…³é”®èµ„æº
        setTimeout(() => {
            nonCriticalResources.forEach(url => this.preloadResource(url));
        }, 100);
        
        console.log('å‡è¡¡åŠ è½½ç­–ç•¥ï¼šå…³é”®èµ„æºä¼˜å…ˆ');
    }
    
    async conservativeLoading() {
        // æ…¢é€Ÿç½‘ç»œï¼šåªåŠ è½½å¿…è¦èµ„æº
        const essentialResources = ['/css/minimal.css'];
        
        await Promise.all(essentialResources.map(url => this.preloadResource(url)));
        
        // æ‡’åŠ è½½å…¶ä»–èµ„æº
        this.setupLazyLoading();
        
        console.log('ä¿å®ˆåŠ è½½ç­–ç•¥ï¼šæœ€å°åŒ–èµ„æºåŠ è½½');
    }
    
    preloadResource(url) {
        return new Promise((resolve, reject) => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.href = url;
            link.as = this.getResourceType(url);
            link.onload = resolve;
            link.onerror = reject;
            document.head.appendChild(link);
        });
    }
    
    getResourceType(url) {
        if (url.endsWith('.css')) return 'style';
        if (url.endsWith('.js')) return 'script';
        if (url.match(/\.(jpg|jpeg|png|webp|svg)$/)) return 'image';
        if (url.match(/\.(woff|woff2|ttf|otf)$/)) return 'font';
        return 'fetch';
    }
}
```

#### 3. å›¾ç‰‡åŠ è½½ä¼˜åŒ–
```javascript
// ç°ä»£å›¾ç‰‡åŠ è½½ç³»ç»Ÿ
class ModernImageLoader {
    constructor() {
        this.intersectionObserver = this.createIntersectionObserver();
        this.supportedFormats = this.detectSupportedFormats();
    }
    
    detectSupportedFormats() {
        const canvas = document.createElement('canvas');
        const formats = {
            webp: canvas.toDataURL('image/webp').indexOf('data:image/webp') === 0,
            avif: canvas.toDataURL('image/avif').indexOf('data:image/avif') === 0,
            jxl: false // JPEG XL æ”¯æŒæ£€æµ‹
        };
        
        return formats;
    }
    
    createIntersectionObserver() {
        return new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    this.loadImage(entry.target);
                    this.intersectionObserver.unobserve(entry.target);
                }
            });
        }, {
            rootMargin: '50px',  // æå‰50pxå¼€å§‹åŠ è½½
            threshold: 0.1
        });
    }
    
    setupLazyImages() {
        const lazyImages = document.querySelectorAll('img[data-src]');
        lazyImages.forEach(img => {
            this.intersectionObserver.observe(img);
        });
    }
    
    loadImage(img) {
        const baseUrl = img.dataset.src;
        const sizes = img.dataset.sizes || '100vw';
        
        // ç”Ÿæˆå“åº”å¼å›¾ç‰‡URL
        const srcset = this.generateResponsiveSrcset(baseUrl, sizes);
        
        // åˆ›å»ºæ–°å›¾ç‰‡å…ƒç´ ç”¨äºé¢„åŠ è½½
        const newImg = new Image();
        
        newImg.onload = () => {
            // å›¾ç‰‡åŠ è½½å®Œæˆï¼Œæ›´æ–°å±æ€§
            img.src = newImg.src;
            img.srcset = newImg.srcset;
            img.classList.add('loaded');
            
            // æ·»åŠ æ·¡å…¥åŠ¨ç”»
            img.style.opacity = '0';
            img.style.transition = 'opacity 0.3s';
            requestAnimationFrame(() => {
                img.style.opacity = '1';
            });
        };
        
        newImg.onerror = () => {
            // å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå ä½å›¾
            img.src = this.generatePlaceholder(img.clientWidth, img.clientHeight);
            img.classList.add('error');
        };
        
        newImg.srcset = srcset;
        newImg.sizes = sizes;
    }
    
    generateResponsiveSrcset(baseUrl, sizes) {
        const breakpoints = [320, 480, 768, 1024, 1280, 1920];
        const format = this.getBestFormat();
        
        return breakpoints.map(width => {
            const url = this.buildImageUrl(baseUrl, width, format);
            return `${url} ${width}w`;
        }).join(', ');
    }
    
    getBestFormat() {
        if (this.supportedFormats.avif) return 'avif';
        if (this.supportedFormats.webp) return 'webp';
        return 'jpg';
    }
    
    buildImageUrl(baseUrl, width, format) {
        // æ ¹æ®å›¾ç‰‡æœåŠ¡æ„å»º URLï¼ˆä¾‹å¦‚ Cloudinaryã€ImageKit ç­‰ï¼‰
        return `${baseUrl}?w=${width}&f=${format}&q=auto`;
    }
    
    generatePlaceholder(width, height) {
        // SVG å ä½å›¾
        const svg = `
            <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#f0f0f0"/>
                <text x="50%" y="50%" text-anchor="middle" dy="0.3em" fill="#999">
                    å›¾ç‰‡åŠ è½½å¤±è´¥
                </text>
            </svg>
        `;
        return `data:image/svg+xml;base64,${btoa(svg)}`;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const imageLoader = new ModernImageLoader();
Document.addEventListener('DOMContentLoaded', () => {
    imageLoader.setupLazyImages();
});
```

### ç½‘ç»œè¯·æ±‚ä¼˜åŒ–

#### 1. HTTP/2 æœåŠ¡å™¨æ¨é€ä¼˜åŒ–
```javascript
// Node.js HTTP/2 æœåŠ¡å™¨ç«¯å®ç°
const http2 = require('http2');
const fs = require('fs');
const path = require('path');

class HTTP2Server {
    constructor() {
        this.server = http2.createSecureServer({
            key: fs.readFileSync('server.key'),
            cert: fs.readFileSync('server.crt')
        });
        
        this.setupPushStrategy();
    }
    
    setupPushStrategy() {
        this.server.on('stream', (stream, headers) => {
            const method = headers[':method'];
            const path = headers[':path'];
            
            if (method === 'GET' && path === '/') {
                this.handleIndexRequest(stream, headers);
            }
        });
    }
    
    handleIndexRequest(stream, headers) {
        // é¢„æµ‹ç”¨æˆ·éœ€è¦çš„èµ„æº
        const criticalResources = [
            { path: '/css/critical.css', type: 'text/css' },
            { path: '/js/app.js', type: 'application/javascript' },
            { path: '/fonts/main.woff2', type: 'font/woff2' }
        ];
        
        // æ‰§è¡ŒæœåŠ¡å™¨æ¨é€
        criticalResources.forEach(resource => {
            this.pushResource(stream, resource);
        });
        
        // è¿”å›HTML
        const html = this.generateHTML();
        stream.respond({
            ':status': 200,
            'content-type': 'text/html; charset=utf-8',
            'cache-control': 'public, max-age=3600'
        });
        stream.end(html);
    }
    
    pushResource(stream, resource) {
        try {
            // æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦å·²ç¼“å­˜
            if (this.shouldPush(resource.path)) {
                stream.pushStream({ ':path': resource.path }, (err, pushStream) => {
                    if (err) {
                        console.error('æœåŠ¡å™¨æ¨é€å¤±è´¥:', err);
                        return;
                    }
                    
                    const fileContent = fs.readFileSync(path.join(__dirname, 'public', resource.path));
                    
                    pushStream.respond({
                        ':status': 200,
                        'content-type': resource.type,
                        'cache-control': 'public, max-age=86400'
                    });
                    
                    pushStream.end(fileContent);
                    console.log(`æ¨é€èµ„æº: ${resource.path}`);
                });
            }
        } catch (error) {
            console.error('æ¨é€èµ„æºå¤±è´¥:', error);
        }
    }
    
    shouldPush(resourcePath) {
        // ç®€åŒ–çš„æ¨é€ç­–ç•¥ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºé¦–æ¬¡è®¿é—®
        // å®é™…ä¸­åº”è¯¥æ ¹æ® Cookieã€Referer ç­‰ä¿¡æ¯åˆ¤æ–­
        return true;
    }
    
    generateHTML() {
        return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>é«˜æ€§èƒ½ç½‘ç«™</title>
            <link rel="stylesheet" href="/css/critical.css">
        </head>
        <body>
            <h1>æ¬¢è¿æ¥åˆ°é«˜æ€§èƒ½ç½‘ç«™</h1>
            <script src="/js/app.js"></script>
        </body>
        </html>
        `;
    }
}
```

#### 2. è¯·æ±‚åˆå¹¶ä¸æ‰¹å¤„ç†
```javascript
// æ™ºèƒ½è¯·æ±‚åˆå¹¶ç³»ç»Ÿ
class RequestBatcher {
    constructor() {
        this.batches = new Map();
        this.timeouts = new Map();
        this.batchDelay = 10; // 10ms åˆå¹¶çª—å£
    }
    
    // è‡ªåŠ¨åˆå¹¶ç›¸ä¼¼çš„APIè¯·æ±‚
    async request(url, options = {}) {
        const batchKey = this.getBatchKey(url, options);
        
        if (!this.batches.has(batchKey)) {
            this.batches.set(batchKey, []);
        }
        
        return new Promise((resolve, reject) => {
            const batch = this.batches.get(batchKey);
            batch.push({ url, options, resolve, reject });
            
            // è®¾ç½®æ‰¹å¤„ç†å®šæ—¶å™¨
            if (!this.timeouts.has(batchKey)) {
                const timeoutId = setTimeout(() => {
                    this.executeBatch(batchKey);
                }, this.batchDelay);
                
                this.timeouts.set(batchKey, timeoutId);
            }
        });
    }
    
    getBatchKey(url, options) {
        // æ ¹æ®URLå’Œè¯·æ±‚å‚æ•°ç”Ÿæˆæ‰¹å¤„ç†é”®
        const baseUrl = url.split('?')[0];
        const method = options.method || 'GET';
        return `${method}:${baseUrl}`;
    }
    
    async executeBatch(batchKey) {
        const batch = this.batches.get(batchKey);
        if (!batch || batch.length === 0) return;
        
        // æ¸…ç†å®šæ—¶å™¨å’Œæ‰¹å¤„ç†
        clearTimeout(this.timeouts.get(batchKey));
        this.timeouts.delete(batchKey);
        this.batches.delete(batchKey);
        
        try {
            if (batch.length === 1) {
                // å•ä¸ªè¯·æ±‚ç›´æ¥æ‰§è¡Œ
                const { url, options, resolve, reject } = batch[0];
                const response = await fetch(url, options);
                resolve(response);
            } else {
                // å¤šä¸ªè¯·æ±‚åˆå¹¶æ‰§è¡Œ
                await this.executeBatchedRequests(batch);
            }
        } catch (error) {
            // æ‰¹å¤„ç†å¤±è´¥ï¼Œé€šçŸ¥æ‰€æœ‰è¯·æ±‚
            batch.forEach(({ reject }) => reject(error));
        }
    }
    
    async executeBatchedRequests(batch) {
        // æ„å»ºæ‰¹å¤„ç†è¯·æ±‚
        const batchRequest = {
            requests: batch.map(({ url, options }, index) => ({
                id: index,
                url: url,
                method: options.method || 'GET',
                headers: options.headers || {},
                body: options.body
            }))
        };
        
        // å‘é€æ‰¹å¤„ç†è¯·æ±‚åˆ°æœåŠ¡å™¨
        const response = await fetch('/api/batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(batchRequest)
        });
        
        const batchResponse = await response.json();
        
        // åˆ†å‘å“åº”ç»“æœ
        batchResponse.responses.forEach((res, index) => {
            const { resolve, reject } = batch[index];
            
            if (res.status >= 200 && res.status < 300) {
                resolve({
                    ok: true,
                    status: res.status,
                    json: () => Promise.resolve(res.body),
                    text: () => Promise.resolve(JSON.stringify(res.body))
                });
            } else {
                reject(new Error(`Request failed with status ${res.status}`));
            }
        });
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const batcher = new RequestBatcher();

// è¿™äº›è¯·æ±‚å°†è¢«è‡ªåŠ¨åˆå¹¶
async function loadUserData() {
    const [profile, settings, notifications] = await Promise.all([
        batcher.request('/api/user/profile'),
        batcher.request('/api/user/settings'),
        batcher.request('/api/user/notifications')
    ]);
    
    console.log('ç”¨æˆ·æ•°æ®åŠ è½½å®Œæˆ');
}
```

### ä¼ è¾“ä¼˜åŒ–

**1. å‹ç¼©ç®—æ³•å¯¹æ¯”ï¼š**
```
Gzip:    å‹ç¼©ç‡70-80%ï¼ŒCPUæ¶ˆè€—ä¸­ç­‰ï¼Œå…¼å®¹æ€§æœ€å¥½
Brotli:  å‹ç¼©ç‡75-85%ï¼ŒCPUæ¶ˆè€—è¾ƒé«˜ï¼Œç°ä»£æµè§ˆå™¨æ”¯æŒ
Deflate: å‹ç¼©ç‡65-75%ï¼ŒCPUæ¶ˆè€—è¾ƒä½ï¼Œè¾ƒå°‘ä½¿ç”¨
```

---

## ç½‘ç»œå®‰å…¨ä¸é˜²æŠ¤

### å¸¸è§æ”»å‡»ä¸é˜²æŠ¤

**1. XSSé˜²æŠ¤ï¼š**
```http
# Content Security Policy
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'

# XSS Protection
X-XSS-Protection: 1; mode=block
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
```

**2. CSRFé˜²æŠ¤ï¼š**
```javascript
// CSRF TokenéªŒè¯
app.use((req, res, next) => {
    if (['POST', 'PUT', 'DELETE'].includes(req.method)) {
        const token = req.headers['x-csrf-token'] || req.body._token;
        if (!validateCSRFToken(token, req.session)) {
            return res.status(403).json({ error: 'Invalid CSRF token' });
        }
    }
    next();
});
```

**æ€»ç»“ï¼š**
å‰ç«¯ç½‘ç»œçŸ¥è¯†æ¶µç›–äº†ä»URLè¾“å…¥åˆ°é¡µé¢å±•ç¤ºçš„å®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬DNSè§£æã€TCPè¿æ¥ã€HTTPåè®®ã€ç¼“å­˜æœºåˆ¶ã€CDNåˆ†å‘ç­‰æ ¸å¿ƒæŠ€æœ¯ã€‚ç†è§£è¿™äº›åº•å±‚åŸç†å¯¹äºå‰ç«¯æ€§èƒ½ä¼˜åŒ–å’Œé—®é¢˜æ’æŸ¥è‡³å…³é‡è¦ã€‚ç°ä»£Webå¼€å‘ä¸­ï¼ŒHTTP/2ã€HTTP/3ã€Service Workerç­‰æ–°æŠ€æœ¯æ­£åœ¨é©å‘½æ€§åœ°æ”¹å–„ç”¨æˆ·ä½“éªŒã€‚

## Service Worker ç¼“å­˜ç­–ç•¥æ·±åº¦è§£æ

### Service Worker ç”Ÿå‘½å‘¨æœŸ

```javascript
// Service Worker å®‰è£…å’Œæ¿€æ´»
self.addEventListener('install', event => {
    console.log('Service Worker å®‰è£…ä¸­...');
    
    // é¢„ç¼“å­˜å…³é”®èµ„æº
    event.waitUntil(
        caches.open('v1').then(cache => {
            return cache.addAll([
                '/',
                '/css/critical.css',
                '/js/app.js',
                '/offline.html'
            ]);
        })
    );
    
    // å¼ºåˆ¶è·³è¿‡ç­‰å¾…
    self.skipWaiting();
});

self.addEventListener('activate', event => {
    console.log('Service Worker å·²æ¿€æ´»');
    
    // æ¸…ç†æ—§ç¼“å­˜
    event.waitUntil(
        caches.keys().then(cacheNames => {
            return Promise.all(
                cacheNames.map(cacheName => {
                    if (cacheName !== 'v1') {
                        return caches.delete(cacheName);
                    }
                })
            );
        })
    );
    
    // ç«‹å³æ§åˆ¶æ‰€æœ‰é¡µé¢
    return self.clients.claim();
});
```

### é«˜çº§ç¼“å­˜ç­–ç•¥å®ç°

```javascript
// å¤šé‡ç¼“å­˜ç­–ç•¥
class CacheStrategyManager {
    constructor() {
        this.strategies = {
            'cache-first': this.cacheFirst.bind(this),
            'network-first': this.networkFirst.bind(this),
            'stale-while-revalidate': this.staleWhileRevalidate.bind(this),
            'network-only': this.networkOnly.bind(this),
            'cache-only': this.cacheOnly.bind(this)
        };
    }
    
    // ç¼“å­˜ä¼˜å…ˆç­–ç•¥
    async cacheFirst(request, cacheName) {
        const cache = await caches.open(cacheName);
        const cachedResponse = await cache.match(request);
        
        if (cachedResponse) {
            return cachedResponse;
        }
        
        try {
            const networkResponse = await fetch(request);
            if (networkResponse.ok) {
                cache.put(request, networkResponse.clone());
            }
            return networkResponse;
        } catch (error) {
            console.error('ç½‘ç»œè¯·æ±‚å¤±è´¥:', error);
            return new Response('ç¦»çº¿æ¨¡å¼', { status: 503 });
        }
    }
    
    // ç½‘ç»œä¼˜å…ˆç­–ç•¥
    async networkFirst(request, cacheName, timeout = 3000) {
        const cache = await caches.open(cacheName);
        
        try {
            const networkResponse = await Promise.race([
                fetch(request),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('ç½‘ç»œè¶…æ—¶')), timeout)
                )
            ]);
            
            if (networkResponse.ok) {
                cache.put(request, networkResponse.clone());
            }
            return networkResponse;
        } catch (error) {
            console.log('ç½‘ç»œå¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜:', error.message);
            const cachedResponse = await cache.match(request);
            return cachedResponse || new Response('èµ„æºä¸å¯ç”¨', { status: 404 });
        }
    }
    
    // è¿‡æœŸæ—¶é‡æ–°éªŒè¯ç­–ç•¥
    async staleWhileRevalidate(request, cacheName, maxAge = 86400000) {
        const cache = await caches.open(cacheName);
        const cachedResponse = await cache.match(request);
        
        // åå°æ›´æ–°
        const fetchPromise = fetch(request).then(response => {
            if (response.ok) {
                cache.put(request, response.clone());
            }
            return response;
        });
        
        if (cachedResponse) {
            const responseTime = new Date(cachedResponse.headers.get('date')).getTime();
            const isStale = (Date.now() - responseTime) > maxAge;
            
            if (isStale) {
                return fetchPromise;
            } else {
                fetchPromise.catch(() => {}); // é™é»˜æ›´æ–°
                return cachedResponse;
            }
        }
        
        return fetchPromise;
    }
}
```

**æœ€ç»ˆæ€»ç»“ï¼š**
é€šè¿‡æ·±å…¥ç†è§£æµè§ˆå™¨URLè¾“å…¥åˆ°é¡µé¢å±•ç¤ºçš„å®Œæ•´ç½‘ç»œæµç¨‹ï¼ŒåŒ…æ‹¬DNSè§£æã€TCP/UDPåè®®ã€HTTPåè®®æ¼”è¿›ã€ç¼“å­˜æœºåˆ¶ã€WebSocketå®æ—¶é€šä¿¡ã€ä»¥åŠç°ä»£ç½‘ç»œå®‰å…¨é˜²æŠ¤ï¼Œå‰ç«¯å¼€å‘è€…èƒ½å¤Ÿæ„å»ºæ›´é«˜æ€§èƒ½ã€æ›´å®‰å…¨çš„Webåº”ç”¨ã€‚è¿™äº›çŸ¥è¯†ä¸ä»…æœ‰åŠ©äºæ—¥å¸¸å¼€å‘å·¥ä½œï¼Œä¹Ÿæ˜¯æŠ€æœ¯é¢è¯•å’Œè§£å†³å¤æ‚ç½‘ç»œé—®é¢˜çš„å…³é”®åŸºç¡€ã€‚