# 2025å¹´Vue2+Vue3çŸ¥è¯†æ·±åº¦è§£æï¼ŒåŒ…å«æºç åŸç†

> åŸºäº2024å¹´æœ€æ–°æŠ€æœ¯å‘å±•å’Œæºç åˆ†æçš„Vue.jsæ·±åº¦æŠ€æœ¯è§£æ
> 
> æ–‡æ¡£åˆ›å»ºæ—¶é—´ï¼š2025å¹´1æœˆ
> 
> ä½œè€…ï¼šAIæŠ€æœ¯åˆ†æå¸ˆ
> 
> èµ„æ–™æ¥æºï¼šVueå®˜æ–¹æ–‡æ¡£ã€CSDNã€æ˜é‡‘ç¤¾åŒºã€çŸ¥ä¹ã€GitHub

## ğŸ“š ç›®å½•

- [ç¬¬ä¸€ç« ï¼šVue2ä¸Vue3æ ¸å¿ƒæ¶æ„å¯¹æ¯”](#ç¬¬ä¸€ç« vue2ä¸vue3æ ¸å¿ƒæ¶æ„å¯¹æ¯”)
- [ç¬¬äºŒç« ï¼šVue3å“åº”å¼ç³»ç»Ÿæºç æ·±åº¦è§£æ](#ç¬¬äºŒç« vue3å“åº”å¼ç³»ç»Ÿæºç æ·±åº¦è§£æ)
- [ç¬¬ä¸‰ç« ï¼šComposition APIæ·±åº¦å‰–æ](#ç¬¬ä¸‰ç« composition-apiæ·±åº¦å‰–æ)
- [ç¬¬å››ç« ï¼šVue3æ€§èƒ½ä¼˜åŒ–åŸç†ä¸å®ç°](#ç¬¬å››ç« vue3æ€§èƒ½ä¼˜åŒ–åŸç†ä¸å®ç°)
- [ç¬¬äº”ç« ï¼šVue3æ–°ç‰¹æ€§æ·±åº¦è§£æ](#ç¬¬äº”ç« vue3æ–°ç‰¹æ€§æ·±åº¦è§£æ)
- [ç¬¬å…­ç« ï¼šVue3ç¼–è¯‘å™¨åŸç†ä¸ä¼˜åŒ–](#ç¬¬å…­ç« vue3ç¼–è¯‘å™¨åŸç†ä¸ä¼˜åŒ–)
- [ç¬¬ä¸ƒç« ï¼šVue3ç”Ÿæ€ç³»ç»Ÿä¸æœ€ä½³å®è·µ](#ç¬¬ä¸ƒç« vue3ç”Ÿæ€ç³»ç»Ÿä¸æœ€ä½³å®è·µ)

---

## ç¬¬ä¸€ç« ï¼šVue2ä¸Vue3æ ¸å¿ƒæ¶æ„å¯¹æ¯”

### 1.1 æ¶æ„æ¼”è¿›æ¦‚è¿°

Vue3ç›¸æ¯”Vue2è¿›è¡Œäº†å…¨é¢çš„é‡æ„ï¼Œä»åº•å±‚æ¶æ„åˆ°APIè®¾è®¡éƒ½æœ‰é‡å¤§æ”¹å˜ã€‚Vue3çš„è®¾è®¡ç›®æ ‡æ˜¯ï¼š

- **æ›´å¥½çš„æ€§èƒ½**ï¼šç¼–è¯‘æ—¶ä¼˜åŒ–ã€æ›´å°çš„åŒ…ä½“ç§¯
- **æ›´å¥½çš„TypeScriptæ”¯æŒ**ï¼šå…¨é¢æ‹¥æŠ±TypeScript
- **æ›´å¥½çš„Composition API**ï¼šè§£å†³é€»è¾‘å¤ç”¨å’Œå¤§å‹åº”ç”¨çš„é—®é¢˜
- **æ›´å¥½çš„Tree-shakingæ”¯æŒ**ï¼šæŒ‰éœ€å¼•å…¥ï¼Œå‡å°‘åŒ…ä½“ç§¯

### 1.2 å“åº”å¼ç³»ç»Ÿå¯¹æ¯”

#### Vue2å“åº”å¼ç³»ç»Ÿ
Vue2ä½¿ç”¨`Object.defineProperty()`å®ç°å“åº”å¼ï¼Œå­˜åœ¨ä»¥ä¸‹é™åˆ¶ï¼š

**Vue2å“åº”å¼å®ç°åˆ†æï¼š**
ä»¥ä¸‹ä»£ç å±•ç¤ºäº†Vue2å¦‚ä½•é€šè¿‡Object.defineProperty()ä¸ºå¯¹è±¡å±æ€§æ·»åŠ getterå’Œsetterï¼Œå®ç°æ•°æ®åŠ«æŒå’Œä¾èµ–æ”¶é›†ã€‚å½“å±æ€§è¢«è®¿é—®æ—¶æ”¶é›†ä¾èµ–ï¼Œå½“å±æ€§è¢«ä¿®æ”¹æ—¶é€šçŸ¥æ‰€æœ‰ä¾èµ–è¿›è¡Œæ›´æ–°ã€‚

```javascript
// Vue2å“åº”å¼å®ç°åŸç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
function defineReactive(obj, key, val) {
  const dep = new Dep()
  
  Object.defineProperty(obj, key, {
    get() {
      // ä¾èµ–æ”¶é›†
      if (Dep.target) {
        dep.depend()
      }
      return val
    },
    set(newVal) {
      if (newVal !== val) {
        val = newVal
        // è§¦å‘æ›´æ–°
        dep.notify()
      }
    }
  })
}

// Vue2çš„å±€é™æ€§
const data = { count: 0 }
defineReactive(data, 'count', 0)

// âŒ æ— æ³•æ£€æµ‹æ–°å¢å±æ€§
data.newProp = 'value' // ä¸ä¼šè§¦å‘å“åº”å¼

// âŒ æ— æ³•æ£€æµ‹æ•°ç»„ç´¢å¼•å’Œé•¿åº¦å˜åŒ–
data.arr[0] = 'new value' // ä¸ä¼šè§¦å‘å“åº”å¼
data.arr.length = 0 // ä¸ä¼šè§¦å‘å“åº”å¼
```

**Vue2å“åº”å¼çš„é—®é¢˜ï¼š**
1. æ— æ³•æ£€æµ‹å¯¹è±¡å±æ€§çš„æ–°å¢å’Œåˆ é™¤
2. æ— æ³•æ£€æµ‹æ•°ç»„ç´¢å¼•å’Œé•¿åº¦çš„å˜åŒ–
3. éœ€è¦é€’å½’éå†å¯¹è±¡çš„æ‰€æœ‰å±æ€§
4. åˆå§‹åŒ–æ—¶æ€§èƒ½å¼€é”€å¤§

#### Vue3å“åº”å¼ç³»ç»Ÿ
Vue3ä½¿ç”¨`Proxy`å®ç°å“åº”å¼ï¼Œè§£å†³äº†Vue2çš„æ‰€æœ‰é—®é¢˜ï¼š

**Vue3 Proxyå“åº”å¼å®ç°åˆ†æï¼š**
ä»¥ä¸‹ä»£ç å±•ç¤ºäº†Vue3å¦‚ä½•ä½¿ç”¨Proxy APIåˆ›å»ºå“åº”å¼å¯¹è±¡ã€‚Proxyå¯ä»¥æ‹¦æˆªå¯¹è±¡çš„æ‰€æœ‰æ“ä½œï¼ˆgetã€setã€deleteç­‰ï¼‰ï¼Œå®ç°æ›´å®Œæ•´çš„å“åº”å¼èƒ½åŠ›ã€‚ä¸Vue2ä¸åŒï¼ŒProxyå¯ä»¥ç›‘å¬å±æ€§çš„æ–°å¢å’Œåˆ é™¤ï¼Œä¹Ÿèƒ½ç›‘å¬æ•°ç»„ç´¢å¼•å’Œé•¿åº¦çš„å˜åŒ–ã€‚

```javascript
// Vue3å“åº”å¼å®ç°åŸç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
function reactive(target) {
  return new Proxy(target, {
    get(target, key, receiver) {
      // ä¾èµ–æ”¶é›†
      track(target, 'get', key)
      const result = Reflect.get(target, key, receiver)
      
      // æ·±åº¦å“åº”å¼
      if (isObject(result)) {
        return reactive(result)
      }
      return result
    },
    
    set(target, key, value, receiver) {
      const oldValue = target[key]
      const result = Reflect.set(target, key, value, receiver)
      
      // è§¦å‘æ›´æ–°
      if (oldValue !== value) {
        trigger(target, 'set', key, value, oldValue)
      }
      return result
    },
    
    deleteProperty(target, key) {
      const hadKey = hasOwn(target, key)
      const result = Reflect.deleteProperty(target, key)
      
      if (result && hadKey) {
        trigger(target, 'delete', key)
      }
      return result
    }
  })
}

// Vue3çš„ä¼˜åŠ¿
const state = reactive({ 
  count: 0,
  list: [1, 2, 3]
})

// âœ… å¯ä»¥æ£€æµ‹æ–°å¢å±æ€§
state.newProp = 'value' // è§¦å‘å“åº”å¼

// âœ… å¯ä»¥æ£€æµ‹æ•°ç»„å˜åŒ–
state.list[0] = 'new value' // è§¦å‘å“åº”å¼
state.list.length = 0 // è§¦å‘å“åº”å¼
```

### 1.3 ç¼–è¯‘ä¼˜åŒ–å¯¹æ¯”

#### Vue2ç¼–è¯‘ä¼˜åŒ–
Vue2çš„ç¼–è¯‘ä¼˜åŒ–ç›¸å¯¹ç®€å•ï¼š

**Vue2ç¼–è¯‘è¿‡ç¨‹åˆ†æï¼š**
ä»¥ä¸‹ä»£ç å±•ç¤ºäº†Vue2çš„åŸºç¡€ç¼–è¯‘ç»“æœã€‚Vue2å°†æ¨¡æ¿ç¼–è¯‘æˆrenderå‡½æ•°ï¼Œæ¯æ¬¡ç»„ä»¶æ›´æ–°æ—¶éƒ½ä¼šé‡æ–°æ‰§è¡Œæ•´ä¸ªrenderå‡½æ•°ï¼Œåˆ›å»ºå®Œæ•´çš„è™šæ‹ŸDOMæ ‘ã€‚æ²¡æœ‰ç¼–è¯‘æ—¶çš„é™æ€åˆ†æå’Œä¼˜åŒ–æ ‡è®°ã€‚

```javascript
// Vue2ç¼–è¯‘ç»“æœï¼ˆç®€åŒ–ï¼‰
function render() {
  return h('div', [
    h('p', this.message),
    h('p', this.count),
    h('button', { on: { click: this.increment } }, 'Click')
  ])
}
```

#### Vue3ç¼–è¯‘ä¼˜åŒ–
Vue3å¼•å…¥äº†å¤šç§ç¼–è¯‘æ—¶ä¼˜åŒ–ï¼š

**Vue3ç¼–è¯‘ä¼˜åŒ–åˆ†æï¼š**
ä»¥ä¸‹ä»£ç å±•ç¤ºäº†Vue3çš„ç¼–è¯‘ä¼˜åŒ–ç»“æœã€‚ç¼–è¯‘å™¨ä¼šè¿›è¡Œé™æ€åˆ†æï¼Œè¯†åˆ«é™æ€å†…å®¹å¹¶æå‡åˆ°renderå‡½æ•°å¤–éƒ¨ï¼Œä¸ºåŠ¨æ€å†…å®¹æ·»åŠ PatchFlagæ ‡è®°ï¼Œè¿™æ ·åœ¨è¿è¡Œæ—¶å¯ä»¥ç²¾ç¡®å®šä½éœ€è¦æ›´æ–°çš„éƒ¨åˆ†ï¼Œå¤§å¹…æå‡æ¸²æŸ“æ€§èƒ½ã€‚

```javascript
// Vue3ç¼–è¯‘ç»“æœï¼ˆå¸¦ä¼˜åŒ–æ ‡è®°ï¼‰
import { createElementVNode as _createElementVNode, toDisplayString as _toDisplayString } from "vue"

const _hoisted_1 = /*#__PURE__*/_createElementVNode("p", null, "Static content", -1 /* HOISTED */)

export function render(_ctx, _cache) {
  return (_openBlock(), _createElementBlock("div", null, [
    _hoisted_1, // é™æ€æå‡
    _createElementVNode("p", null, _toDisplayString(_ctx.message), 1 /* TEXT */),
    _createElementVNode("p", null, _toDisplayString(_ctx.count), 1 /* TEXT */),
    _createElementVNode("button", {
      onClick: _ctx.increment
    }, "Click", 8 /* PROPS */, ["onClick"])
  ]))
}

// ç¼–è¯‘ä¼˜åŒ–æ ‡è®°è¯´æ˜ï¼š
// 1 /* TEXT */ - æ–‡æœ¬èŠ‚ç‚¹
// 8 /* PROPS */ - åŠ¨æ€å±æ€§
// -1 /* HOISTED */ - é™æ€æå‡
```

**Vue3ç¼–è¯‘ä¼˜åŒ–ç‰¹æ€§ï¼š**
1. **é™æ€æå‡ï¼ˆStatic Hoistingï¼‰**ï¼šé™æ€èŠ‚ç‚¹æå‡åˆ°æ¸²æŸ“å‡½æ•°å¤–éƒ¨
2. **è¡¥ä¸æ ‡è®°ï¼ˆPatch Flagsï¼‰**ï¼šæ ‡è®°åŠ¨æ€å†…å®¹ç±»å‹
3. **å—çº§ä¼˜åŒ–ï¼ˆBlockï¼‰**ï¼šæ”¶é›†åŠ¨æ€èŠ‚ç‚¹ï¼Œå‡å°‘éå†
4. **ç¼“å­˜äº‹ä»¶å¤„ç†å™¨**ï¼šé¿å…ä¸å¿…è¦çš„é‡æ–°åˆ›å»º

### 1.4 åŒ…ä½“ç§¯å¯¹æ¯”

#### Vue2åŒ…ä½“ç§¯
- **å®Œæ•´ç‰ˆ**ï¼š~34KB (gzipped)
- **è¿è¡Œæ—¶ç‰ˆæœ¬**ï¼š~31KB (gzipped)
- **æ‰€æœ‰åŠŸèƒ½æ‰“åŒ…**ï¼šæ— æ³•tree-shaking

#### Vue3åŒ…ä½“ç§¯
- **å®Œæ•´ç‰ˆ**ï¼š~40KB (gzipped)
- **è¿è¡Œæ—¶ç‰ˆæœ¬**ï¼š~16KB (gzipped)
- **æœ€å°åŒ–ä½¿ç”¨**ï¼š~12KB (gzipped)
- **å®Œå…¨æ”¯æŒtree-shaking**

```javascript
// Vue3 tree-shakingç¤ºä¾‹
import { ref, computed } from 'vue'
// åªå¯¼å…¥éœ€è¦çš„åŠŸèƒ½ï¼Œæœªä½¿ç”¨çš„åŠŸèƒ½ä¼šè¢«ç§»é™¤

// è€Œä¸æ˜¯å¯¼å…¥æ•´ä¸ªVue
// import Vue from 'vue' // Vue2æ–¹å¼
```

---

## ç¬¬äºŒç« ï¼šVue3å“åº”å¼ç³»ç»Ÿæºç æ·±åº¦è§£æ

### 2.1 å“åº”å¼ç³»ç»Ÿæ•´ä½“æ¶æ„

Vue3çš„å“åº”å¼ç³»ç»ŸåŸºäºä»¥ä¸‹æ ¸å¿ƒæ¦‚å¿µï¼š

```mermaid
graph TB
    A[reactive] --> B[Proxy]
    A --> C[WeakMapç¼“å­˜]
    A --> D[trackä¾èµ–æ”¶é›†]
    A --> E[triggerè§¦å‘æ›´æ–°]
    
    F[ref] --> G[RefImplç±»]
    F --> H[.valueè®¿é—®å™¨]
    F --> I[track/trigger]
    
    J[computed] --> K[ComputedRefImpl]
    J --> L[lazyè®¡ç®—]
    J --> M[ç¼“å­˜æœºåˆ¶]
    
    N[effect] --> O[ReactiveEffectç±»]
    N --> P[å‰¯ä½œç”¨è¿½è¸ª]
    N --> Q[ä¾èµ–æ›´æ–°]
```

### 2.2 reactiveæºç æ·±åº¦è§£æ

#### 2.2.1 reactiveå‡½æ•°å…¥å£

**reactiveå‡½æ•°ä½œç”¨åˆ†æï¼š**
reactiveå‡½æ•°æ˜¯Vue3å“åº”å¼ç³»ç»Ÿçš„å…¥å£å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªæ™®é€šå¯¹è±¡å¹¶è¿”å›è¯¥å¯¹è±¡çš„å“åº”å¼ä»£ç†ã€‚è¯¥å‡½æ•°é¦–å…ˆæ£€æŸ¥ç›®æ ‡å¯¹è±¡æ˜¯å¦ä¸ºåªè¯»å¯¹è±¡ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›åŸå¯¹è±¡ã€‚å¦åˆ™è°ƒç”¨createReactiveObjectå‡½æ•°åˆ›å»ºProxyä»£ç†å¯¹è±¡ï¼Œå®ç°æ•°æ®åŠ«æŒå’Œå“åº”å¼è½¬æ¢ã€‚

```typescript
// packages/reactivity/src/reactive.ts
export function reactive<T extends object>(target: T): UnwrapNestedRefs<T> {
  // å¦‚æœtargetæ˜¯åªè¯»çš„ï¼Œç›´æ¥è¿”å›target
  if (isReadonly(target)) {
    return target
  }
  
  return createReactiveObject(
    target,
    false, // isReadonly
    mutableHandlers, // æ™®é€šå¯¹è±¡çš„handlers
    mutableCollectionHandlers, // Map/Setç­‰é›†åˆçš„handlers
    reactiveMap // ç¼“å­˜Map
  )
}
```

#### 2.2.2 createReactiveObjectæ ¸å¿ƒå®ç°

**createReactiveObjectå‡½æ•°æ­¥éª¤åˆ†æï¼š**
è¿™æ˜¯å“åº”å¼å¯¹è±¡åˆ›å»ºçš„æ ¸å¿ƒå‡½æ•°ï¼Œå®ƒæ‰§è¡Œä»¥ä¸‹å…³é”®æ­¥éª¤ï¼š
1. **ç±»å‹æ£€æŸ¥**ï¼šç¡®ä¿åªæœ‰å¯¹è±¡ç±»å‹æ‰èƒ½è¢«ä»£ç†ï¼ŒåŸå§‹ç±»å‹ç›´æ¥è¿”å›
2. **é‡å¤ä»£ç†æ£€æŸ¥**ï¼šé˜²æ­¢å¯¹å·²ç»æ˜¯ä»£ç†çš„å¯¹è±¡å†æ¬¡ä»£ç†
3. **ç¼“å­˜æœºåˆ¶**ï¼šä½¿ç”¨WeakMapç¼“å­˜å·²åˆ›å»ºçš„ä»£ç†å¯¹è±¡ï¼Œé¿å…é‡å¤åˆ›å»º
4. **ç›®æ ‡ç±»å‹åˆ¤æ–­**ï¼šåŒºåˆ†æ™®é€šå¯¹è±¡/æ•°ç»„å’Œé›†åˆç±»å‹ï¼ˆMap/Setï¼‰ï¼Œé€‰æ‹©ä¸åŒçš„handlers
5. **Proxyåˆ›å»º**ï¼šä½¿ç”¨ç›¸åº”çš„handlersåˆ›å»ºProxyå¯¹è±¡
6. **ç¼“å­˜å­˜å‚¨**ï¼šå°†æ–°åˆ›å»ºçš„ä»£ç†å¯¹è±¡å­˜å…¥ç¼“å­˜

```typescript
function createReactiveObject(
  target: Target,
  isReadonly: boolean,
  baseHandlers: ProxyHandler<any>,
  collectionHandlers: ProxyHandler<any>,
  proxyMap: WeakMap<Target, any>
) {
  // 1. ç±»å‹æ£€æŸ¥ï¼šåªæœ‰å¯¹è±¡æ‰èƒ½è¢«ä»£ç†
  if (!isObject(target)) {
    if (__DEV__) {
      console.warn(`value cannot be made reactive: ${String(target)}`)
    }
    return target
  }
  
  // 2. é¿å…é‡å¤ä»£ç†ï¼šå¦‚æœtargetå·²ç»æ˜¯ä»£ç†å¯¹è±¡ï¼Œç›´æ¥è¿”å›
  if (
    target[ReactiveFlags.RAW] &&
    !(isReadonly && target[ReactiveFlags.IS_REACTIVE])
  ) {
    return target
  }
  
  // 3. ç¼“å­˜æ£€æŸ¥ï¼šé¿å…åŒä¸€å¯¹è±¡å¤šæ¬¡åˆ›å»ºä»£ç†
  const existingProxy = proxyMap.get(target)
  if (existingProxy) {
    return existingProxy
  }
  
  // 4. ç›®æ ‡ç±»å‹æ£€æŸ¥ï¼šåªæœ‰ç™½åå•ç±»å‹æ‰èƒ½è¢«ä»£ç†
  const targetType = getTargetType(target)
  if (targetType === TargetType.INVALID) {
    return target
  }
  
  // 5. åˆ›å»ºProxyå¯¹è±¡
  const proxy = new Proxy(
    target,
    targetType === TargetType.COLLECTION 
      ? collectionHandlers  // Map/Set/WeakMap/WeakSet
      : baseHandlers        // Object/Array
  )
  
  // 6. ç¼“å­˜ä»£ç†å¯¹è±¡
  proxyMap.set(target, proxy)
  return proxy
}
```

#### 2.2.3 ç›®æ ‡ç±»å‹åˆ¤æ–­

**ç›®æ ‡ç±»å‹åˆ†ç±»æœºåˆ¶åˆ†æï¼š**
è¯¥ä»£ç å®ç°äº†Vue3å¯¹ä¸åŒæ•°æ®ç±»å‹çš„åˆ†ç±»å¤„ç†ç­–ç•¥ã€‚é€šè¿‡TargetTypeæšä¸¾å°†å¯¹è±¡åˆ†ä¸ºä¸‰ç±»ï¼šINVALIDï¼ˆæ— æ•ˆç±»å‹ï¼Œä¸èƒ½è¢«ä»£ç†ï¼‰ã€COMMONï¼ˆæ™®é€šå¯¹è±¡å’Œæ•°ç»„ï¼‰ã€COLLECTIONï¼ˆMap/Setç­‰é›†åˆç±»å‹ï¼‰ã€‚è¿™ç§åˆ†ç±»å†³å®šäº†åç»­ä½¿ç”¨å“ªç§Proxy handlersï¼Œç¡®ä¿ä¸åŒç±»å‹çš„å¯¹è±¡éƒ½èƒ½æ­£ç¡®å®ç°å“åº”å¼ç‰¹æ€§ã€‚

```typescript
// ç›®æ ‡ç±»å‹æšä¸¾
const enum TargetType {
  INVALID = 0,    // æ— æ•ˆç±»å‹
  COMMON = 1,     // æ™®é€šå¯¹è±¡å’Œæ•°ç»„
  COLLECTION = 2  // Mapã€Setã€WeakMapã€WeakSet
}

function getTargetType(value: Target): TargetType {
  return value[ReactiveFlags.SKIP] || !Object.isExtensible(value)
    ? TargetType.INVALID
    : targetTypeMap(toRawType(value))
}

function targetTypeMap(rawType: string) {
  switch (rawType) {
    case 'Object':
    case 'Array':
      return TargetType.COMMON
    case 'Map':
    case 'Set':
    case 'WeakMap':
    case 'WeakSet':
      return TargetType.COLLECTION
    default:
      return TargetType.INVALID
  }
}
```

### 2.3 Proxy Handlersæ·±åº¦åˆ†æ

#### 2.3.1 mutableHandlersè¯¦è§£

```typescript
// packages/reactivity/src/baseHandlers.ts
export const mutableHandlers: ProxyHandler<object> = {
  get,        // å±æ€§è®¿é—®æ‹¦æˆª
  set,        // å±æ€§è®¾ç½®æ‹¦æˆª
  deleteProperty, // å±æ€§åˆ é™¤æ‹¦æˆª
  has,        // inæ“ä½œç¬¦æ‹¦æˆª
  ownKeys     // Object.keysç­‰æ‹¦æˆª
}
```

#### 2.3.2 getæ‹¦æˆªå™¨è¯¦ç»†å®ç°

**getæ‹¦æˆªå™¨å·¥ä½œæµç¨‹åˆ†æï¼š**
è¿™æ˜¯Proxyçš„getæ‹¦æˆªå™¨å®ç°ï¼Œå®ƒåœ¨æ¯æ¬¡å±æ€§è®¿é—®æ—¶æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
1. **ç‰¹æ®Šæ ‡è®°å¤„ç†**ï¼šå¤„ç†Vueå†…éƒ¨çš„å“åº”å¼æ ‡è®°ï¼ˆå¦‚__v_isReactiveï¼‰
2. **æ•°ç»„æ–¹æ³•æ‹¦æˆª**ï¼šå¯¹æ•°ç»„çš„ç‰¹æ®Šæ–¹æ³•ï¼ˆå¦‚pushã€popï¼‰è¿›è¡Œç‰¹æ®Šå¤„ç†
3. **å±æ€§å€¼è·å–**ï¼šä½¿ç”¨Reflect.getè·å–å®é™…å±æ€§å€¼
4. **è¿‡æ»¤ä¸éœ€è¦è¿½è¸ªçš„key**ï¼šSymbolå’Œå†…ç½®å±æ€§ä¸è¿›è¡Œä¾èµ–æ”¶é›†
5. **ä¾èµ–æ”¶é›†**ï¼šè°ƒç”¨trackå‡½æ•°æ”¶é›†å½“å‰å±æ€§çš„ä¾èµ–å…³ç³»
6. **refè‡ªåŠ¨è§£åŒ…**ï¼šå¯¹refå¯¹è±¡è¿›è¡Œè‡ªåŠ¨è§£åŒ…ï¼ˆé™¤æ•°ç»„ç´¢å¼•å¤–ï¼‰
7. **åµŒå¥—å“åº”å¼**ï¼šå¯¹åµŒå¥—å¯¹è±¡é€’å½’åº”ç”¨å“åº”å¼è½¬æ¢

```typescript
function createGetter(isReadonly = false, shallow = false) {
  return function get(target: Target, key: string | symbol, receiver: object) {
    // 1. å¤„ç†ç‰¹æ®Šçš„å“åº”å¼æ ‡è®°
    if (key === ReactiveFlags.IS_REACTIVE) {
      return !isReadonly
    } else if (key === ReactiveFlags.IS_READONLY) {
      return isReadonly
    } else if (key === ReactiveFlags.IS_SHALLOW) {
      return shallow
    } else if (
      key === ReactiveFlags.RAW &&
      receiver === (
        isReadonly
          ? shallow
            ? shallowReadonlyMap
            : readonlyMap
          : shallow
          ? shallowReactiveMap
          : reactiveMap
      ).get(target)
    ) {
      return target
    }

    // 2. æ•°ç»„æ–¹æ³•ç‰¹æ®Šå¤„ç†
    const targetIsArray = isArray(target)
    if (!isReadonly && targetIsArray && hasOwn(arrayInstrumentations, key)) {
      return Reflect.get(arrayInstrumentations, key, receiver)
    }

    // 3. è·å–å±æ€§å€¼
    const res = Reflect.get(target, key, receiver)

    // 4. ç¬¦å·å’Œå†…ç½®é”®ä¸éœ€è¦è¿½è¸ª
    if (isSymbol(key) ? builtInSymbols.has(key) : isNonTrackableKeys(key)) {
      return res
    }

    // 5. ä¾èµ–æ”¶é›†
    if (!isReadonly) {
      track(target, TrackOpTypes.GET, key)
    }

    // 6. æµ…å±‚å“åº”å¼ç›´æ¥è¿”å›
    if (shallow) {
      return res
    }

    // 7. refè‡ªåŠ¨è§£åŒ…
    if (isRef(res)) {
      // æ•°ç»„ç´¢å¼•è®¿é—®ä¸è‡ªåŠ¨è§£åŒ…
      const shouldUnwrap = !targetIsArray || !isIntegerKey(key)
      return shouldUnwrap ? res.value : res
    }

    // 8. åµŒå¥—å¯¹è±¡é€’å½’å“åº”å¼
    if (isObject(res)) {
      return isReadonly ? readonly(res) : reactive(res)
    }

    return res
  }
}
```

#### 2.3.3 setæ‹¦æˆªå™¨è¯¦ç»†å®ç°

**setæ‹¦æˆªå™¨å·¥ä½œæµç¨‹åˆ†æï¼š**
è¿™æ˜¯Proxyçš„setæ‹¦æˆªå™¨å®ç°ï¼Œè´Ÿè´£å±æ€§è®¾ç½®æ—¶çš„å“åº”å¼æ›´æ–°ï¼š
1. **æ—§å€¼è·å–**ï¼šä¿å­˜å½“å‰å±æ€§çš„æ—§å€¼ç”¨äºæ¯”è¾ƒ
2. **åªè¯»æ£€æŸ¥**ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºåªè¯»refï¼Œé˜²æ­¢æ„å¤–ä¿®æ”¹
3. **refç‰¹æ®Šå¤„ç†**ï¼šå¦‚æœæ—§å€¼æ˜¯refè€Œæ–°å€¼ä¸æ˜¯ï¼Œç›´æ¥è®¾ç½®refçš„value
4. **æ“ä½œç±»å‹åˆ¤æ–­**ï¼šåŒºåˆ†æ˜¯æ–°å¢å±æ€§è¿˜æ˜¯ä¿®æ”¹ç°æœ‰å±æ€§
5. **å€¼è®¾ç½®**ï¼šä½¿ç”¨Reflect.setæ‰§è¡Œå®é™…çš„å±æ€§è®¾ç½®
6. **å˜åŒ–æ£€æµ‹**ï¼šæ¯”è¾ƒæ–°æ—§å€¼ï¼Œåªæœ‰çœŸæ­£æ”¹å˜æ—¶æ‰è§¦å‘æ›´æ–°
7. **ä¾èµ–è§¦å‘**ï¼šè°ƒç”¨triggerå‡½æ•°é€šçŸ¥æ‰€æœ‰ä¾èµ–è¿›è¡Œæ›´æ–°

```typescript
function createSetter(shallow = false) {
  return function set(
    target: object,
    key: string | symbol,
    value: unknown,
    receiver: object
  ): boolean {
    // 1. è·å–æ—§å€¼
    let oldValue = (target as any)[key]
    
    if (isReadonly(oldValue) && isRef(oldValue) && !isRef(value)) {
      return false
    }
    
    if (!shallow) {
      if (!isShallow(value) && !isReadonly(value)) {
        oldValue = toRaw(oldValue)
        value = toRaw(value)
      }
      // refç‰¹æ®Šå¤„ç†ï¼šç›´æ¥è®¾ç½®refçš„value
      if (!isArray(target) && isRef(oldValue) && !isRef(value)) {
        oldValue.value = value
        return true
      }
    }

    // 2. åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯ä¿®æ”¹
    const hadKey = isArray(target) && isIntegerKey(key)
      ? Number(key) < target.length
      : hasOwn(target, key)
    
    // 3. è®¾ç½®æ–°å€¼
    const result = Reflect.set(target, key, value, receiver)

    // 4. è§¦å‘å“åº”å¼æ›´æ–°
    if (target === toRaw(receiver)) {
      if (!hadKey) {
        // æ–°å¢å±æ€§
        trigger(target, TriggerOpTypes.ADD, key, value)
      } else if (hasChanged(value, oldValue)) {
        // ä¿®æ”¹å±æ€§
        trigger(target, TriggerOpTypes.SET, key, value, oldValue)
      }
    }

    return result
  }
}
```

### 2.4 ä¾èµ–æ”¶é›†ç³»ç»Ÿï¼ˆtrackï¼‰

#### 2.4.1 ä¾èµ–æ”¶é›†æ•°æ®ç»“æ„

```typescript
// å…¨å±€ä¾èµ–æ˜ å°„ï¼štarget -> Map<key, Set<effect>>
type KeyToDepMap = Map<any, Dep>
const targetMap = new WeakMap<any, KeyToDepMap>()

// ä¾èµ–é›†åˆ
type Dep = Set<ReactiveEffect> & TrackedMarkers

// å½“å‰æ´»è·ƒçš„effect
let activeEffect: ReactiveEffect | undefined
```

#### 2.4.2 trackå‡½æ•°å®ç°

**ä¾èµ–æ”¶é›†æ ¸å¿ƒæœºåˆ¶åˆ†æï¼š**
trackå‡½æ•°æ˜¯Vue3å“åº”å¼ç³»ç»Ÿçš„ä¾èµ–æ”¶é›†æ ¸å¿ƒï¼Œå®ƒå»ºç«‹äº†å“åº”å¼æ•°æ®å’Œå‰¯ä½œç”¨å‡½æ•°ä¹‹é—´çš„è”ç³»ï¼š
1. **è¿½è¸ªæ£€æŸ¥**ï¼šç¡®è®¤å½“å‰ç¯å¢ƒå…è®¸ä¾èµ–æ”¶é›†ä¸”å­˜åœ¨æ´»è·ƒçš„effect
2. **ç›®æ ‡å¯¹è±¡æ˜ å°„**ï¼šä»WeakMapä¸­è·å–æˆ–åˆ›å»ºç›®æ ‡å¯¹è±¡çš„ä¾èµ–æ˜ å°„è¡¨
3. **å±æ€§ä¾èµ–é›†åˆ**ï¼šä¸ºå…·ä½“å±æ€§åˆ›å»ºæˆ–è·å–ä¾èµ–é›†åˆï¼ˆSetï¼‰
4. **ä¾èµ–å…³ç³»å»ºç«‹**ï¼šè°ƒç”¨trackEffectså°†å½“å‰æ´»è·ƒeffectæ·»åŠ åˆ°ä¾èµ–é›†åˆä¸­

trackEffectså‡½æ•°è¿›ä¸€æ­¥å®ç°äº†åŒå‘ç»‘å®šï¼š
- å°†effectæ·»åŠ åˆ°å±æ€§çš„ä¾èµ–é›†åˆä¸­
- å°†å±æ€§çš„ä¾èµ–é›†åˆæ·»åŠ åˆ°effectçš„depsåˆ—è¡¨ä¸­
è¿™ç§åŒå‘å…³ç³»ä½¿å¾—æ¸…ç†å’Œæ›´æ–°éƒ½æ›´åŠ é«˜æ•ˆã€‚

```typescript
export function track(target: object, type: TrackOpTypes, key: unknown) {
  // 1. æ£€æŸ¥æ˜¯å¦åº”è¯¥è¿½è¸ª
  if (shouldTrack && activeEffect) {
    // 2. è·å–targetçš„ä¾èµ–æ˜ å°„
    let depsMap = targetMap.get(target)
    if (!depsMap) {
      targetMap.set(target, (depsMap = new Map()))
    }
    
    // 3. è·å–keyçš„ä¾èµ–é›†åˆ
    let dep = depsMap.get(key)
    if (!dep) {
      depsMap.set(key, (dep = createDep()))
    }

    // 4. æ”¶é›†ä¾èµ–
    trackEffects(dep, {
      target,
      type,
      key
    })
  }
}

export function trackEffects(
  dep: Dep,
  debuggerEventExtraInfo?: DebuggerEventExtraInfo
) {
  let shouldTrack = false
  
  if (effectTrackDepth <= maxMarkerBits) {
    if (!newTracked(dep)) {
      dep.n |= trackOpBit // è®¾ç½®æ–°è¿½è¸ªæ ‡è®°
      shouldTrack = !wasTracked(dep)
    }
  } else {
    // æ·±åº¦è¿½è¸ªå›é€€
    shouldTrack = !dep.has(activeEffect!)
  }

  if (shouldTrack) {
    dep.add(activeEffect!) // æ·»åŠ åˆ°ä¾èµ–é›†åˆ
    activeEffect!.deps.push(dep) // effectè®°å½•ä¾èµ–

    if (__DEV__ && activeEffect!.onTrack) {
      activeEffect!.onTrack({
        effect: activeEffect!,
        ...debuggerEventExtraInfo!
      })
    }
  }
}
```

### 2.5 è§¦å‘æ›´æ–°ç³»ç»Ÿï¼ˆtriggerï¼‰

#### 2.5.1 triggerå‡½æ•°å®ç°

**ä¾èµ–è§¦å‘æ ¸å¿ƒæœºåˆ¶åˆ†æï¼š**
triggerå‡½æ•°æ˜¯Vue3å“åº”å¼ç³»ç»Ÿçš„æ›´æ–°è§¦å‘æ ¸å¿ƒï¼Œå½“å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶è´Ÿè´£é€šçŸ¥æ‰€æœ‰ç›¸å…³çš„å‰¯ä½œç”¨ï¼š
1. **ä¾èµ–æ˜ å°„è·å–**ï¼šä»å…¨å±€targetMapä¸­è·å–ç›®æ ‡å¯¹è±¡çš„ä¾èµ–å…³ç³»
2. **æ“ä½œç±»å‹åˆ†ç±»**ï¼šæ ¹æ®ä¸åŒçš„æ“ä½œç±»å‹ï¼ˆADD/DELETE/SET/CLEARï¼‰æ”¶é›†éœ€è¦è§¦å‘çš„effects
3. **ç‰¹æ®Šæƒ…å†µå¤„ç†**ï¼š
   - CLEARæ“ä½œï¼šè§¦å‘æ‰€æœ‰ä¾èµ–
   - æ•°ç»„é•¿åº¦å˜åŒ–ï¼šç‰¹æ®Šå¤„ç†æ•°ç»„ç´¢å¼•å’Œé•¿åº¦ç›¸å…³çš„ä¾èµ–
   - è¿­ä»£å™¨ä¾èµ–ï¼šå¤„ç†for...inç­‰è¿­ä»£æ“ä½œçš„ä¾èµ–
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šåŒºåˆ†å•ä¸ªå’Œå¤šä¸ªä¾èµ–é›†åˆï¼Œé‡‡ç”¨ä¸åŒçš„å¤„ç†ç­–ç•¥
5. **æ‰¹é‡æ‰§è¡Œ**ï¼šæ”¶é›†æ‰€æœ‰éœ€è¦è§¦å‘çš„effectsåç»Ÿä¸€æ‰§è¡Œ

```typescript
export function trigger(
  target: object,
  type: TriggerOpTypes,
  key?: unknown,
  newValue?: unknown,
  oldValue?: unknown,
  oldTarget?: Map<unknown, unknown> | Set<unknown>
) {
  // 1. è·å–ä¾èµ–æ˜ å°„
  const depsMap = targetMap.get(target)
  if (!depsMap) {
    // æ²¡æœ‰ä¾èµ–ï¼Œç›´æ¥è¿”å›
    return
  }

  // 2. æ”¶é›†éœ€è¦æ‰§è¡Œçš„effects
  let deps: (Dep | undefined)[] = []
  
  if (type === TriggerOpTypes.CLEAR) {
    // æ¸…ç©ºæ“ä½œï¼šè§¦å‘æ‰€æœ‰ä¾èµ–
    deps = [...depsMap.values()]
  } else if (key === 'length' && isArray(target)) {
    // æ•°ç»„é•¿åº¦å˜åŒ–ï¼šç‰¹æ®Šå¤„ç†
    const newLength = Number(newValue)
    depsMap.forEach((dep, key) => {
      if (key === 'length' || key >= newLength) {
        deps.push(dep)
      }
    })
  } else {
    // æ™®é€šå±æ€§å˜åŒ–
    if (key !== void 0) {
      deps.push(depsMap.get(key))
    }

    // æ·»åŠ è¿­ä»£å™¨ç›¸å…³ä¾èµ–
    switch (type) {
      case TriggerOpTypes.ADD:
        if (!isArray(target)) {
          deps.push(depsMap.get(ITERATE_KEY))
          if (isMap(target)) {
            deps.push(depsMap.get(MAP_KEY_ITERATE_KEY))
          }
        } else if (isIntegerKey(key)) {
          deps.push(depsMap.get('length'))
        }
        break
      case TriggerOpTypes.DELETE:
        if (!isArray(target)) {
          deps.push(depsMap.get(ITERATE_KEY))
          if (isMap(target)) {
            deps.push(depsMap.get(MAP_KEY_ITERATE_KEY))
          }
        }
        break
      case TriggerOpTypes.SET:
        if (isMap(target)) {
          deps.push(depsMap.get(ITERATE_KEY))
        }
        break
    }
  }

  // 3. æ‰§è¡Œeffects
  const eventInfo = __DEV__
    ? { target, type, key, newValue, oldValue, oldTarget }
    : undefined

  if (deps.length === 1) {
    if (deps[0]) {
      if (__DEV__) {
        triggerEffects(deps[0], eventInfo)
      } else {
        triggerEffects(deps[0])
      }
    }
  } else {
    const effects: ReactiveEffect[] = []
    for (const dep of deps) {
      if (dep) {
        effects.push(...dep)
      }
    }
    if (__DEV__) {
      triggerEffects(createDep(effects), eventInfo)
    } else {
      triggerEffects(createDep(effects))
    }
  }
}
```

#### 2.5.2 triggerEffectså®ç°

**effectæ‰§è¡Œä¼˜å…ˆçº§æœºåˆ¶åˆ†æï¼š**
triggerEffectså‡½æ•°å®ç°äº†æ™ºèƒ½çš„effectæ‰§è¡Œé¡ºåºç®¡ç†ï¼š
1. **æ•°æ®ç»Ÿä¸€**ï¼šå°†ä¼ å…¥çš„ä¾èµ–é›†åˆè½¬æ¢ä¸ºæ•°ç»„å½¢å¼ä»¥ä¾¿å¤„ç†
2. **computedä¼˜å…ˆæ‰§è¡Œ**ï¼šå…ˆæ‰§è¡Œæ‰€æœ‰computedç±»å‹effectï¼Œç¡®ä¿è®¡ç®—å±æ€§å…ˆæ›´æ–°
3. **æ™®é€šeffectåæ‰§è¡Œ**ï¼šå†æ‰§è¡Œæ™®é€šçš„å“åº”å¼effectï¼Œå¦‚watchã€ç»„ä»¶æ›´æ–°ç­‰

è¿™ç§æ‰§è¡Œé¡ºåºç¡®ä¿äº†ï¼š
- computedå€¼åœ¨è¢«ä½¿ç”¨æ—¶å·²ç»æ˜¯æœ€æ–°çš„
- é¿å…äº†ä¸å¿…è¦çš„é‡å¤è®¡ç®—
- ä¿è¯äº†æ›´æ–°çš„ä¸€è‡´æ€§å’Œæ­£ç¡®æ€§

triggerEffectå‡½æ•°è¿›ä¸€æ­¥å¤„ç†å•ä¸ªeffectçš„æ‰§è¡Œï¼š
- é˜²æ­¢é€’å½’æ‰§è¡Œï¼ˆé™¤éæ˜¾å¼å…è®¸ï¼‰
- æ”¯æŒè°ƒåº¦å™¨ï¼ˆschedulerï¼‰æœºåˆ¶ï¼Œå®ç°å¼‚æ­¥æ›´æ–°
- æä¾›è°ƒè¯•æ”¯æŒï¼ˆonTriggerå›è°ƒï¼‰

```typescript
export function triggerEffects(
  dep: Dep | ReactiveEffect[],
  debuggerEventExtraInfo?: DebuggerEventExtraInfo
) {
  // è½¬æ¢ä¸ºæ•°ç»„å½¢å¼
  const effects = isArray(dep) ? dep : [...dep]

  // 1. å…ˆè§¦å‘computed effects
  for (const effect of effects) {
    if (effect.computed) {
      triggerEffect(effect, debuggerEventExtraInfo)
    }
  }
  
  // 2. å†è§¦å‘æ™®é€šeffects
  for (const effect of effects) {
    if (!effect.computed) {
      triggerEffect(effect, debuggerEventExtraInfo)
    }
  }
}

function triggerEffect(
  effect: ReactiveEffect,
  debuggerEventExtraInfo?: DebuggerEventExtraInfo
) {
  if (effect !== activeEffect || effect.allowRecurse) {
    if (__DEV__ && effect.onTrigger) {
      effect.onTrigger(extend({ effect }, debuggerEventExtraInfo))
    }
    
    if (effect.scheduler) {
      // å¦‚æœæœ‰è°ƒåº¦å™¨ï¼Œä½¿ç”¨è°ƒåº¦å™¨æ‰§è¡Œ
      effect.scheduler()
    } else {
      // ç›´æ¥æ‰§è¡Œeffect
      effect.run()
    }
  }
}
```

---

## ç¬¬ä¸‰ç« ï¼šComposition APIæ·±åº¦å‰–æ

### 3.1 refæºç æ·±åº¦è§£æ

#### 3.1.1 refå®ç°åŸç†

**refå“åº”å¼å°è£…æœºåˆ¶åˆ†æï¼š**
refæ˜¯Vue3ä¸­å¤„ç†åŸºæœ¬ç±»å‹å“åº”å¼çš„æ ¸å¿ƒAPIï¼Œå®ƒé€šè¿‡å°†å€¼å°è£…åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­æ¥å®ç°å“åº”å¼ï¼š
1. **å…¥å£å‡½æ•°**ï¼šref()å‡½æ•°æ¥æ”¶ä»»æ„å€¼ï¼Œè°ƒç”¨createRefåˆ›å»ºRefImplå®ä¾‹
2. **é‡å¤æ£€æŸ¥**ï¼šå¦‚æœä¼ å…¥çš„å·²ç»æ˜¯refå¯¹è±¡ï¼Œç›´æ¥è¿”å›é¿å…åŒé‡å°è£…
3. **RefImplç±»**ï¼š
   - `_value`ï¼šå­˜å‚¨å“åº”å¼å¤„ç†åçš„å€¼
   - `_rawValue`ï¼šå­˜å‚¨åŸå§‹å€¼ï¼Œç”¨äºæ¯”è¾ƒæ˜¯å¦å˜åŒ–
   - `__v_isRef`ï¼šæ ‡è®°ä¸ºrefå¯¹è±¡ï¼Œç”¨äºç±»å‹æ£€æŸ¥
4. **getter/setter**ï¼š
   - getï¼šè°ƒç”¨trackRefValueè¿›è¡Œä¾èµ–æ”¶é›†ï¼Œè¿”å›å“åº”å¼å€¼
   - setï¼šæ£€æŸ¥å€¼æ˜¯å¦å˜åŒ–ï¼Œå˜åŒ–æ—¶è°ƒç”¨triggerRefValueè§¦å‘æ›´æ–°
5. **æ·±åº¦å“åº”å¼**ï¼šå¯¹äºå¯¹è±¡ç±»å‹ï¼Œè‡ªåŠ¨è°ƒç”¨toReactiveè½¬æ¢ä¸ºå“åº”å¼å¯¹è±¡

```typescript
// packages/reactivity/src/ref.ts
export function ref(value?: unknown) {
  return createRef(value, false)
}

function createRef(rawValue: unknown, shallow: boolean) {
  if (isRef(rawValue)) {
    return rawValue
  }
  return new RefImpl(rawValue, shallow)
}

class RefImpl<T> {
  private _value: T
  private _rawValue: T
  public dep?: Dep = undefined
  public readonly __v_isRef = true

  constructor(value: T, public readonly __v_isShallow: boolean) {
    this._rawValue = __v_isShallow ? value : toRaw(value)
    this._value = __v_isShallow ? value : toReactive(value)
  }

  get value() {
    trackRefValue(this) // ä¾èµ–æ”¶é›†
    return this._value
  }

  set value(newVal) {
    const useDirectValue = this.__v_isShallow || isShallow(newVal) || isReadonly(newVal)
    newVal = useDirectValue ? newVal : toRaw(newVal)
    
    if (hasChanged(newVal, this._rawValue)) {
      this._rawValue = newVal
      this._value = useDirectValue ? newVal : toReactive(newVal)
      triggerRefValue(this, newVal) // è§¦å‘æ›´æ–°
    }
  }
}
```

### 3.2 computedæºç è§£æ

**computedæ‡’åŠ è½½è®¡ç®—æœºåˆ¶åˆ†æï¼š**
computedå®ç°äº†é«˜æ•ˆçš„è®¡ç®—å±æ€§æœºåˆ¶ï¼Œå…·æœ‰ç¼“å­˜å’Œæ‡’åŠ è½½ç‰¹æ€§ï¼š
1. **å‚æ•°å¤„ç†**ï¼šæ”¯æŒgetterå‡½æ•°æˆ–{get, set}å¯¹è±¡ä¸¤ç§å½¢å¼
2. **ComputedRefImplæ ¸å¿ƒæœºåˆ¶**ï¼š
   - `_dirty`ï¼šç¼“å­˜æ ‡è®°ï¼Œæ ‡è¯†æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—
   - `effect`ï¼šåŒ…è£…getterçš„ReactiveEffectï¼Œè´Ÿè´£ä¾èµ–æ”¶é›†
   - è°ƒåº¦å™¨ï¼šå½“ä¾èµ–å˜åŒ–æ—¶è®¾ç½®_dirty=trueå¹¶è§¦å‘æ›´æ–°
3. **æ‡’è®¡ç®—ç­–ç•¥**ï¼šåªæœ‰åœ¨_dirty=trueæ—¶æ‰é‡æ–°æ‰§è¡Œeffect.run()
4. **ç¼“å­˜æœºåˆ¶**ï¼šè®¡ç®—ç»“æœç¼“å­˜åœ¨_valueä¸­ï¼Œé¿å…é‡å¤è®¡ç®—
5. **ä¾èµ–é“¾å¼æ›´æ–°**ï¼šä½œä¸ºrefå¯¹è±¡ï¼Œè‡ªèº«ä¹Ÿå¯ä»¥è¢«å…¶ä»–computedæˆ–effectä¾èµ–

```typescript
export function computed<T>(
  getterOrOptions: ComputedGetter<T> | WritableComputedOptions<T>
) {
  let getter: ComputedGetter<T>
  let setter: ComputedSetter<T>

  const onlyGetter = isFunction(getterOrOptions)
  if (onlyGetter) {
    getter = getterOrOptions
    setter = NOOP
  } else {
    getter = getterOrOptions.get
    setter = getterOrOptions.set
  }

  return new ComputedRefImpl(getter, setter, onlyGetter || !setter)
}

class ComputedRefImpl<T> {
  public dep?: Dep = undefined
  private _value!: T
  public readonly effect: ReactiveEffect<T>
  public _dirty = true // ç¼“å­˜æ ‡è®°

  constructor(
    getter: ComputedGetter<T>,
    private readonly _setter: ComputedSetter<T>,
    isReadonly: boolean
  ) {
    this.effect = new ReactiveEffect(getter, () => {
      if (!this._dirty) {
        this._dirty = true
        triggerRefValue(this)
      }
    })
    this.effect.computed = this
  }

  get value() {
    const self = toRaw(this)
    trackRefValue(self)
    
    if (self._dirty) {
      self._dirty = false
      self._value = self.effect.run()!
    }
    return self._value
  }
}
```

### 3.3 watchå’ŒwatchEffectåŸç†

**watchç³»åˆ—APIç»Ÿä¸€å®ç°æœºåˆ¶åˆ†æï¼š**
watchEffectå’Œwatchå†…éƒ¨éƒ½ä½¿ç”¨doWatchå‡½æ•°å®ç°ï¼Œæä¾›äº†çµæ´»çš„å“åº”å¼ç›‘å¬èƒ½åŠ›ï¼š
1. **æ•°æ®æºå¤„ç†**ï¼š
   - å‡½æ•°ç±»å‹ï¼šç›´æ¥ä½œä¸ºgetterä½¿ç”¨
   - ref/reactiveï¼šè‡ªåŠ¨æå–å€¼æˆ–éå†å±æ€§
   - æ•°ç»„ï¼šæ”¯æŒå¤šæ•°æ®æºç›‘å¬
2. **æ‰§è¡Œç­–ç•¥**ï¼š
   - watchEffectï¼šæ— å›è°ƒï¼Œç›´æ¥æ‰§è¡Œgetterå‡½æ•°
   - watchï¼šæœ‰å›è°ƒï¼Œæ¯”è¾ƒæ–°æ—§å€¼åæ‰§è¡Œå›è°ƒ
3. **è°ƒåº¦æœºåˆ¶**ï¼š
   - syncï¼šåŒæ­¥æ‰§è¡Œ
   - preï¼šç»„ä»¶æ›´æ–°å‰æ‰§è¡Œï¼ˆé»˜è®¤ï¼‰
   - postï¼šç»„ä»¶æ›´æ–°åæ‰§è¡Œ
4. **æ¸…ç†æœºåˆ¶**ï¼šæ”¯æŒonCleanupå›è°ƒï¼Œç”¨äºæ¸…ç†å‰¯ä½œç”¨
5. **é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨callWithAsyncErrorHandlingç»Ÿä¸€å¤„ç†å¼‚æ­¥é”™è¯¯
6. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šè¿”å›åœæ­¢å‡½æ•°ï¼Œæ”¯æŒæ‰‹åŠ¨å–æ¶ˆç›‘å¬

```typescript
export function watchEffect(
  effect: WatchEffect,
  options?: WatchOptionsBase
): WatchStopHandle {
  return doWatch(effect, null, options)
}

function doWatch(
  source: WatchSource | WatchEffect,
  cb: WatchCallback | null,
  options: WatchOptions = EMPTY_OBJ
): WatchStopHandle {
  let getter: () => any
  
  if (isFunction(source)) {
    if (cb) {
      getter = () => callWithErrorHandling(source, instance, ErrorCodes.WATCH_GETTER)
    } else {
      getter = () => {
        if (cleanup) cleanup()
        return callWithAsyncErrorHandling(source, instance, ErrorCodes.WATCH_CALLBACK, [onCleanup])
      }
    }
  }

  const job: SchedulerJob = () => {
    if (cb) {
      const newValue = effect.run()
      if (deep || forceTrigger || hasChanged(newValue, oldValue)) {
        if (cleanup) cleanup()
        callWithAsyncErrorHandling(cb, instance, ErrorCodes.WATCH_CALLBACK, [
          newValue,
          oldValue === INITIAL_WATCHER_VALUE ? undefined : oldValue,
          onCleanup
        ])
        oldValue = newValue
      }
    } else {
      effect.run()
    }
  }

  const effect = new ReactiveEffect(getter, scheduler)
  
  if (cb) {
    if (immediate) job()
    else oldValue = effect.run()
  } else {
    effect.run()
  }

  return () => {
    effect.stop()
  }
}
```

---

## ç¬¬å››ç« ï¼šVue3æ€§èƒ½ä¼˜åŒ–åŸç†

### 4.1 ç¼–è¯‘æ—¶ä¼˜åŒ–

#### 4.1.1 é™æ€æå‡ï¼ˆStatic Hoistingï¼‰

**é™æ€æå‡ä¼˜åŒ–åŸç†åˆ†æï¼š**
é™æ€æå‡æ˜¯Vue3ç¼–è¯‘å™¨çš„é‡è¦ä¼˜åŒ–ç­–ç•¥ï¼Œå®ƒåœ¨ç¼–è¯‘é˜¶æ®µè¯†åˆ«é™æ€å†…å®¹å¹¶ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ï¼š
1. **é™æ€åˆ†æ**ï¼šç¼–è¯‘å™¨åˆ†ææ¨¡æ¿ï¼Œè¯†åˆ«ä¸ä¾èµ–ä»»ä½•å“åº”å¼æ•°æ®çš„DOMèŠ‚ç‚¹
2. **æå‡æ“ä½œ**ï¼šå°†é™æ€èŠ‚ç‚¹çš„åˆ›å»ºæ“ä½œæå‡åˆ°renderå‡½æ•°å¤–éƒ¨
3. **æ€§èƒ½æå‡**ï¼š
   - å‡å°‘æ¯æ¬¡æ¸²æŸ“æ—¶çš„VNodeåˆ›å»ºæ¬¡æ•°
   - é™ä½GCå‹åŠ›ï¼Œå‡å°‘å†…å­˜åˆ†é…
   - æé«˜æ¸²æŸ“å‡½æ•°æ‰§è¡Œæ•ˆç‡
4. **æ ‡è®°ç³»ç»Ÿ**ï¼šä½¿ç”¨HOISTED = -1æ ‡è®°é™æ€èŠ‚ç‚¹ï¼Œåœ¨diffè¿‡ç¨‹ä¸­ç›´æ¥è·³è¿‡

**ä¼˜åŒ–å‰ï¼š**
```vue
<template>
  <div>
    <h1>Static Title</h1>
    <p>{{ message }}</p>
  </div>
</template>
```

**Vue2ç¼–è¯‘ç»“æœï¼š**
```javascript
function render() {
  return h('div', [
    h('h1', 'Static Title'),  // æ¯æ¬¡éƒ½åˆ›å»º
    h('p', this.message)
  ])
}
```

**Vue3ç¼–è¯‘ç»“æœï¼ˆé™æ€æå‡ï¼‰ï¼š**
```javascript
// é™æ€èŠ‚ç‚¹æå‡åˆ°æ¸²æŸ“å‡½æ•°å¤–éƒ¨
const _hoisted_1 = createElementVNode("h1", null, "Static Title", -1)

function render(_ctx, _cache) {
  return (openBlock(), createElementBlock("div", null, [
    _hoisted_1,  // å¤ç”¨é™æ€èŠ‚ç‚¹
    createElementVNode("p", null, toDisplayString(_ctx.message), 1)
  ]))
}
```

#### 4.1.2 è¡¥ä¸æ ‡è®°ï¼ˆPatch Flagsï¼‰

**è¡¥ä¸æ ‡è®°ç²¾å‡†æ›´æ–°æœºåˆ¶åˆ†æï¼š**
è¡¥ä¸æ ‡è®°æ˜¯Vue3å®ç°ç²¾å‡†æ›´æ–°çš„æ ¸å¿ƒæœºåˆ¶ï¼Œé€šè¿‡åœ¨ç¼–è¯‘é˜¶æ®µæ ‡è®°åŠ¨æ€å†…å®¹ç±»å‹ï¼Œåœ¨è¿è¡Œæ—¶å®ç°é«˜æ•ˆdiffï¼š
1. **ç¼–è¯‘æ—¶æ ‡è®°**ï¼šç¼–è¯‘å™¨åˆ†ææ¨¡æ¿ï¼Œä¸ºæ¯ä¸ªåŠ¨æ€èŠ‚ç‚¹æ·»åŠ ç›¸åº”çš„PatchFlag
2. **ç±»å‹åˆ†ç±»**ï¼š
   - TEXT(1)ï¼šåŠ¨æ€æ–‡æœ¬å†…å®¹
   - CLASS(2)ï¼šåŠ¨æ€classå±æ€§
   - STYLE(4)ï¼šåŠ¨æ€styleå±æ€§
   - PROPS(8)ï¼šåŠ¨æ€å…¶ä»–å±æ€§
3. **è¿è¡Œæ—¶ä¼˜åŒ–**ï¼šdiffç®—æ³•æ ¹æ®æ ‡è®°åªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†
4. **æ€§èƒ½æå‡**ï¼šé¿å…å…¨é‡å±æ€§æ¯”è¾ƒï¼Œå¤§å¹…å‡å°‘diffå¼€é”€

```typescript
export const enum PatchFlags {
  TEXT = 1,          // åŠ¨æ€æ–‡æœ¬
  CLASS = 1 << 1,    // åŠ¨æ€class
  STYLE = 1 << 2,    // åŠ¨æ€style
  PROPS = 1 << 3,    // åŠ¨æ€å±æ€§
  HOISTED = -1,      // é™æ€æå‡
}
```

### 4.2 Tree-shakingæ”¯æŒ

**Vue3æ¨¡å—åŒ–æ¶æ„åˆ†æï¼š**
Vue3é‡æ–°è®¾è®¡äº†æ¨¡å—æ¶æ„ï¼Œå®ç°äº†å®Œæ•´çš„Tree-shakingæ”¯æŒï¼Œå¤§å¹…å‡å°‘äº†æ‰“åŒ…ä½“ç§¯ï¼š
1. **å…¨å±€APIæ‹†åˆ†**ï¼šå°†Vue2çš„å…¨å±€APIæ‹†åˆ†ä¸ºç‹¬ç«‹å‡½æ•°ï¼Œæ”¯æŒæŒ‰éœ€å¯¼å…¥
2. **ES Moduleæ”¯æŒ**ï¼šä½¿ç”¨ES6æ¨¡å—è¯­æ³•ï¼Œä½¿æ‰“åŒ…å·¥å…·èƒ½å¤Ÿé™æ€åˆ†æä¾èµ–
3. **å‰¯ä½œç”¨æ ‡è®°**ï¼šä½¿ç”¨/*#__PURE__*/æ³¨é‡Šæ ‡è®°æ— å‰¯ä½œç”¨çš„å‡½æ•°è°ƒç”¨
4. **æ¡ä»¶ç¼–è¯‘**ï¼šå¼€å‘/ç”Ÿäº§ç¯å¢ƒçš„ä»£ç åˆ†æ”¯å¯ä»¥è¢«æ­£ç¡®è¯†åˆ«å’Œç§»é™¤

**Vue2å…¨é‡å¯¼å…¥ï¼š**
```javascript
import Vue from 'vue'
// æ•´ä¸ªVueè¢«æ‰“åŒ…ï¼Œæ— æ³•tree-shaking
```

**Vue3æŒ‰éœ€å¯¼å…¥ï¼š**
```javascript
import { ref, computed, watch } from 'vue'
// åªæ‰“åŒ…ä½¿ç”¨çš„åŠŸèƒ½ï¼Œæœªä½¿ç”¨çš„ä¼šè¢«ç§»é™¤
```

---

## ç¬¬äº”ç« ï¼šVue3æ–°ç‰¹æ€§æ·±åº¦è§£æ

### 5.1 Fragmentæ”¯æŒ

**Vue2é™åˆ¶ï¼š**
```vue
<!-- å¿…é¡»æœ‰æ ¹å…ƒç´  -->
<template>
  <div>
    <header>Header</header>
    <main>Content</main>
  </div>
</template>
```

**Vue3æ”¯æŒï¼š**
```vue
<!-- æ”¯æŒå¤šä¸ªæ ¹å…ƒç´  -->
<template>
  <header>Header</header>
  <main>Content</main>
  <footer>Footer</footer>
</template>
```

### 5.2 Teleportä¼ é€é—¨

```vue
<template>
  <div>
    <h1>App Component</h1>
    <!-- ä¼ é€åˆ°body -->
    <Teleport to="body">
      <div class="modal">
        <h2>Modal Content</h2>
      </div>
    </Teleport>
  </div>
</template>
```

### 5.3 Suspenseå¼‚æ­¥ç»„ä»¶

```vue
<template>
  <Suspense>
    <!-- å¼‚æ­¥ç»„ä»¶ -->
    <template #default>
      <AsyncComponent />
    </template>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <template #fallback>
      <div>Loading...</div>
    </template>
  </Suspense>
</template>

<script setup>
import { defineAsyncComponent } from 'vue'

const AsyncComponent = defineAsyncComponent(async () => {
  await new Promise(resolve => setTimeout(resolve, 2000))
  return import('./components/HeavyComponent.vue')
})
</script>
```

---

## æ€»ç»“

Vue3ç›¸æ¯”Vue2åœ¨å¤šä¸ªæ–¹é¢å®ç°äº†é‡å¤§çªç ´ï¼š

1. **å“åº”å¼ç³»ç»Ÿ**ï¼šä»Object.definePropertyå‡çº§åˆ°Proxyï¼Œè§£å†³äº†Vue2çš„è¯¸å¤šé™åˆ¶
2. **ç¼–è¯‘ä¼˜åŒ–**ï¼šé™æ€æå‡ã€è¡¥ä¸æ ‡è®°ã€å—çº§ä¼˜åŒ–ç­‰å¤§å¹…æå‡æ€§èƒ½
3. **Composition API**ï¼šæ›´å¥½çš„é€»è¾‘å¤ç”¨å’Œç±»å‹æ¨å¯¼
4. **Tree-shaking**ï¼šæŒ‰éœ€å¼•å…¥ï¼Œå‡å°‘åŒ…ä½“ç§¯
5. **TypeScriptæ”¯æŒ**ï¼šå®Œå…¨ä½¿ç”¨TypeScripté‡å†™ï¼Œæä¾›æ›´å¥½çš„ç±»å‹æ”¯æŒ

è¿™äº›æ”¹è¿›ä½¿Vue3åœ¨æ€§èƒ½ã€å¼€å‘ä½“éªŒå’Œç»´æŠ¤æ€§æ–¹é¢éƒ½æœ‰äº†æ˜¾è‘—æå‡ã€‚

---

## Vue3å“åº”å¼ç³»ç»Ÿå®Œæ•´æµç¨‹å›¾

```mermaid
flowchart TD
    %% å“åº”å¼å¯¹è±¡åˆ›å»ºæµç¨‹
    A["ğŸ”„ ç”¨æˆ·è°ƒç”¨ reactive(obj)"] --> B{"ğŸ” æ£€æŸ¥å¯¹è±¡ç±»å‹"}
    B -->|"isObject"| C["ğŸ“ è·å–æˆ–åˆ›å»ºä»£ç†ç¼“å­˜"]
    B -->|"!isObject"| Z1["âŒ è¿”å›åŸå€¼"]
    
    C --> D{"ğŸ’¿ ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨"}
    D -->|"Hit"| Z2["âœ… è¿”å›ç¼“å­˜ä»£ç†"]
    D -->|"Miss"| E["ğŸ­ åˆ›å»º Proxy å¯¹è±¡"]
    
    E --> F["ğŸ–¼ï¸ è®¾ç½® Proxy Handlers"]
    F --> G["ğŸ’¾ å­˜å…¥ç¼“å­˜ proxyMap"]
    G --> H["âœ¨ è¿”å›å“åº”å¼å¯¹è±¡"]
    
    %% å±æ€§è®¿é—®æµç¨‹
    H --> I["ğŸ’† ç”¨æˆ·è®¿é—®å±æ€§ obj.prop"]
    I --> J["ğŸ¯ Proxy get æ‹¦æˆªå™¨"]
    J --> K["ğŸ” æ£€æŸ¥ç‰¹æ®Š key"]
    K --> L["ğŸ“ è°ƒç”¨ track(ä¾èµ–æ”¶é›†)"]
    
    %% ä¾èµ–æ”¶é›†æµç¨‹
    L --> M["ğŸ“Š targetMap.get(target)"]
    M --> N{"ğŸ—ºï¸ ç›®æ ‡å¯¹è±¡æ˜ å°„å­˜åœ¨?"}
    N -->|"No"| O["ğŸ† åˆ›å»º new Map()"]
    N -->|"Yes"| P["ğŸ“¦ è·å–å±æ€§ä¾èµ–é›†åˆ"]
    O --> P
    
    P --> Q{"ğŸ”— å±æ€§ä¾èµ–é›†åˆå­˜åœ¨?"}
    Q -->|"No"| R["ğŸ† åˆ›å»º new Set()"]
    Q -->|"Yes"| S["ğŸ“ å°† activeEffect æ·»åŠ åˆ°é›†åˆ"]
    R --> S
    
    S --> T["ğŸ”„ åŒå‘ç»‘å®š: effect.deps.push(dep)"]
    T --> U["ğŸ“ è¿”å›å±æ€§å€¼"]
    
    %% å±æ€§ä¿®æ”¹æµç¨‹
    U --> V["âœï¸ ç”¨æˆ·ä¿®æ”¹å±æ€§ obj.prop = newVal"]
    V --> W["ğŸ¯ Proxy set æ‹¦æˆªå™¨"]
    W --> X["ğŸ” æ£€æŸ¥å€¼æ˜¯å¦å˜åŒ–"]
    X --> Y{"ğŸ”„ hasChanged(newVal, oldVal)"}
    Y -->|"No Change"| Z3["âŒ è¿”å› false"]
    Y -->|"Changed"| AA["ğŸ“ è°ƒç”¨ trigger(è§¦å‘æ›´æ–°)"]
    
    %% ä¾èµ–è§¦å‘æµç¨‹
    AA --> BB["ğŸ“Š ä» targetMap è·å–ä¾èµ–"]
    BB --> CC{"ğŸ—ºï¸ ä¾èµ–æ˜ å°„å­˜åœ¨?"}
    CC -->|"No"| Z4["âŒ æ— ä¾èµ–ï¼Œç›´æ¥è¿”å›"]
    CC -->|"Yes"| DD["ğŸ“¦ æ”¶é›†æ‰€æœ‰éœ€è¦è§¦å‘çš„ effects"]
    
    DD --> EE["ğŸ“Š åŒºåˆ† computed å’Œ æ™®é€š effects"]
    EE --> FF["ğŸ§® å…ˆæ‰§è¡Œ computed effects"]
    FF --> GG["ğŸ”„ å†æ‰§è¡Œæ™®é€š effects"]
    
    GG --> HH["ğŸ“ æ¸²æŸ“æ›´æ–°å®Œæˆ"]
    
    %% ref æµç¨‹
    II["ğŸ”„ ç”¨æˆ·è°ƒç”¨ ref(value)"] --> JJ["ğŸ“ åˆ›å»º RefImpl å®ä¾‹"]
    JJ --> KK["ğŸ’¾ å­˜å‚¨ _value å’Œ _rawValue"]
    KK --> LL["ğŸ’† ç”¨æˆ·è®¿é—® ref.value"]
    LL --> MM["ğŸ“ trackRefValue(ä¾èµ–æ”¶é›†)"]
    MM --> NN["ğŸ“ è¿”å› _value"]
    
    NN --> OO["âœï¸ ç”¨æˆ·è®¾ç½® ref.value = newVal"]
    OO --> PP["ğŸ” æ£€æŸ¥å€¼æ˜¯å¦å˜åŒ–"]
    PP --> QQ{"ğŸ”„ hasChanged(newVal, _rawValue)"}
    QQ -->|"No Change"| Z5["âŒ ä¸è§¦å‘æ›´æ–°"]
    QQ -->|"Changed"| RR["ğŸ”„ æ›´æ–° _value å’Œ _rawValue"]
    RR --> SS["ğŸ“ triggerRefValue(è§¦å‘æ›´æ–°)"]
    SS --> TT["ğŸ“ ref æ›´æ–°å®Œæˆ"]
    
    %% computed æµç¨‹
    UU["ğŸ”„ ç”¨æˆ·è°ƒç”¨ computed(getter)"] --> VV["ğŸ“ åˆ›å»º ComputedRefImpl"]
    VV --> WW["ğŸ”„ åˆ›å»º ReactiveEffect(getter)"]
    WW --> XX["ğŸ·ï¸ è®¾ç½® _dirty = true"]
    XX --> YY["ğŸ’† ç”¨æˆ·è®¿é—® computed.value"]
    
    YY --> ZZ{"ğŸ” æ£€æŸ¥ _dirty æ ‡è®°"}
    ZZ -->|"dirty=false"| AAA["ğŸ’¿ è¿”å›ç¼“å­˜çš„ _value"]
    ZZ -->|"dirty=true"| BBB["ğŸ”„ æ‰§è¡Œ effect.run()"]
    BBB --> CCC["ğŸ“ ä¾èµ–æ”¶é›† + è®¡ç®—æ–°å€¼"]
    CCC --> DDD["ğŸ·ï¸ è®¾ç½® _dirty = false"]
    DDD --> EEE["ğŸ’¾ ç¼“å­˜ _value"]
    EEE --> FFF["ğŸ“ è¿”å›è®¡ç®—ç»“æœ"]
    
    %% é¢œè‰²å’Œæ ·å¼
    classDef userAction fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef proxyAction fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    classDef trackAction fill:#e8f5e8,stroke:#4caf50,stroke-width:2px
    classDef triggerAction fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef returnAction fill:#fce4ec,stroke:#e91e63,stroke-width:2px
    
    class A,I,V,II,LL,OO,UU,YY userAction
    class J,W,F,E proxyAction
    class L,M,N,O,P,Q,R,S,T,MM trackAction
    class AA,BB,DD,EE,FF,GG,SS triggerAction
    class H,U,HH,Z1,Z2,Z3,Z4,Z5,NN,TT,AAA,FFF returnAction
```

è¯¥æµç¨‹å›¾å±•ç¤ºäº†Vue3å“åº”å¼ç³»ç»Ÿçš„å®Œæ•´å·¥ä½œæµç¨‹ï¼ŒåŒ…æ‹¬ï¼š

1. **å“åº”å¼å¯¹è±¡åˆ›å»º**ï¼šreactive() å‡½æ•°çš„å®Œæ•´æµç¨‹
2. **ä¾èµ–æ”¶é›†æœºåˆ¶**ï¼šå±æ€§è®¿é—®æ—¶çš„trackè¿‡ç¨‹
3. **ä¾èµ–è§¦å‘æœºåˆ¶**ï¼šå±æ€§ä¿®æ”¹æ—¶çš„triggerè¿‡ç¨‹
4. **refå“åº”å¼**ï¼šrefçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
5. **computedè®¡ç®—å±æ€§**ï¼šæ‡’åŠ è½½å’Œç¼“å­˜æœºåˆ¶

æ¯ä¸ªæ­¥éª¤éƒ½ç”¨ä¸åŒé¢œè‰²åŒºåˆ†ï¼Œæ–¹ä¾¿ç†è§£æ•´ä¸ªç³»ç»Ÿçš„å·¥ä½œåŸç†ã€‚
```
